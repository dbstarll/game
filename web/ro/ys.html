<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>原神计算器</title>
    <link rel='stylesheet' href='https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/icon?family=Material+Icons'>
    <link rel='stylesheet' href='/ro/css/normalize.css'>
    <link rel='stylesheet' href='/ro/css/material-icons.css'>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://code.jquery.com/ui/1.13.1/jquery-ui.min.js'></script>
    <script src='/ro/js/jform/jform.min.js'></script>
    <script src='/ro/js/jsonpath-0.8.0.js'></script>
    <script src='/ro/js/common.js'></script>
    <script src='/ro/js/dialog.js'></script>
    <style>
        html {
            font-size: 14px;
        }

        #main {
            display: flex;
            margin: 5px;
            column-gap: 5px;
        }

        #main > div:first-child {
            flex: 1;
        }

        #main > div:last-child {
            flex: 2;
        }

        div.row {
            display: flex;
            align-items: center;
            column-gap: 5px;
            margin: 5px;
        }

        div.column:first-child {
            flex-basis: 8ch;
        }

        div.column > label {
            display: block;
            text-align: center;
            font-size: 0.5em;
        }

        div.column > div {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        div.column > div > span:first-child {
            display: block;
            font-size: 1.2em;
        }

        div.column > div > span:last-child {
            display: block;
            font-size: 0.5em;
        }

        span[raise].up {
            color: red;
        }

        span[raise].down {
            color: green;
        }

        div.input {
            display: flex;
            align-items: center;
            column-gap: 5px;
            margin: 5px;
        }

        div.input > label {
            flex-basis: 12ch;
            text-align: right;
        }
    </style>
    <script>
        function column(label, newValue) {
            if ('number' === typeof newValue) {
                $('span[column=\'' + label + '\']').each((_, span) => {
                    const percentage = true === $.data(span, 'percentage');
                    let value = newValue * (percentage ? 100 : 1);
                    $.data(span, 'value', value);

                    value = Math.round((value + Number.EPSILON) * 10000) / 10000;
                    const v1 = value + '';
                    const v2 = value.toFixed(percentage ? 2 : 0);
                    let displayValue = v1.length > v2.length ? v2 : v1;
                    $(span).text(displayValue + (percentage ? '%' : ''));

                    const checkpoint = $.data(span, 'checkpoint');
                    $(span).next('span[raise]').each((_, raise) => {
                        let displayRaise = '', classRaise = '';
                        if ('number' === typeof checkpoint) {
                            const raiseValue = Math.round((value - checkpoint + Number.EPSILON) * 10000) / 10000;
                            if (raiseValue != 0) {
                                classRaise = raiseValue > 0 ? 'up' : "down";
                                if (checkpoint == 0) {
                                    displayRaise = raiseValue;
                                } else {
                                    const percentageValue = Math.round(((100 * raiseValue / checkpoint) + Number.EPSILON) * 10000) / 10000;
                                    displayRaise = percentageValue.toFixed(1) + '%';
                                }
                                displayRaise = (raiseValue > 0 ? '+' : '') + displayRaise;
                            }
                        }
                        $(raise).removeClass('up down').text(displayRaise).addClass(classRaise);
                    });
                });
            } else {
                let value = false;
                let percentage = false;
                $('input[type=text][column=\'' + label + '\']').each((_, input) => {
                    value = $(input).val();
                    percentage = true === $.data(input, 'percentage');
                    return false;
                });
                if (false === value) {
                    $('span[column=\'' + label + '\']').each((_, span) => {
                        value = $.data(span, 'value');
                        if ('number' !== typeof value) {
                            value = $(span).text();
                        }
                        percentage = true === $.data(span, 'percentage');
                        return false;
                    });
                }
                const num = parseFloat(value);
                return isNaN(num) ? 0.0 : num / (percentage ? 100 : 1);
            }
        }

        function calc() {
            column('人物攻击力', column('人物攻击力'));
            column('武器攻击力', column('武器攻击力'));
            column('基础攻击力', column('人物攻击力') + column('武器攻击力'));
            column('百分比攻击力', column('百分比攻击力'));
            column('固定攻击力', column('固定攻击力'));
            column('额外攻击力', column('基础攻击力') * column('百分比攻击力') + column('固定攻击力'));
            column('总攻击力', column('基础攻击力') + column('额外攻击力'));

            column('物理伤害加成', column('物理伤害加成'));
            column('元素伤害加成', column('元素伤害加成'));
            column('元素影响增伤', column('元素影响增伤'));
            column('造成伤害提高', column('造成伤害提高'));
            column('伤害加成系数', 1 + column('物理伤害加成') + column('元素伤害加成') + column('元素影响增伤') + column('造成伤害提高'));

            column('暴击率', column('暴击率'));
            column('暴击伤害', column('暴击伤害'));
            column('暴击收益', 1 + column('暴击率') * column('暴击伤害'));

            column('最终伤害', column('总攻击力') * column('伤害加成系数') * column('暴击收益'));
        }


        function setupCheckpoint() {
            $('span[column]').each((_, span) => {
                const value = $.data(span, 'value');
                if ('number' === typeof value) {
                    $.data(span, 'checkpoint', value);
                }
            });
            $('input[type=text][column]').each((_, input) => {
                const value = $(input).val();
                $.data(input, 'checkpoint', value);
            });
            calc();
        }

        function deleteCheckpoint() {
            $('span[column]').each((_, span) => {
                $.removeData(span, 'checkpoint');
            });
            $('input[type=text][column]').each((_, input) => {
                $.removeData(input, 'checkpoint');
            });
            calc();
        }

        function resetCheckpoint() {
            $('input[type=text][column]').each((_, input) => {
                const value = $.data(input, 'checkpoint');
                if ('string' === typeof value) {
                    $(input).val(value);
                }
            });
            calc();
        }

        function newRow() {
            return $.html.div().addClass('row');
        }

        function newColumn(label, percentage = false) {
            const column = $.html.div().addClass('column')
                .append($.html.div()
                    .append($.html.span({column: label}).text(true === percentage ? '0%' : '0'))
                    .append($.html.span({raise: label})))
                .append($.html.label().text(label));
            if (true === percentage) {
                column.find('span[column]').each((_, span) => {
                    $.data(span, 'percentage', percentage);
                });
            }
            return column;
        }

        function newInput(label, step = 1, percentage = false) {
            const input = $.html.div().addClass('input')
                .append($.html.label().text(label))
                .append($.html.input({type: 'text', column: label}));
            input.children('input[type=text]').each((_, input) => {
                if (step !== 1) {
                    $.data(input, 'step', step);
                }
                if (true === percentage) {
                    $.data(input, 'percentage', percentage);
                }
            });
            return input;
        }

        function symbol(symbol) {
            return $.html.div().addClass('symbol').text(symbol);
        }

        function initQuality(quality) {
            initQualityBase(quality.children('fieldset.Basis'));
            initQualityAdvanced(quality.children('fieldset.Advanced'));
            initQualityElemental(quality.children('fieldset.Elemental'));
            quality.find('input[type=text]').each((_, input) => {
                $(input).spinner({
                    numberFormat: 'n',
                    step: $.data(input, 'step') || 1,
                    min: 0,
                    spin: calc
                }).spinner('value', 0).on("spinchange", calc);
            }).on('focus', function () {
                $(this).trigger('select');
            });
        }

        function initQualityBase(container) {
            container.append(newInput('人物攻击力'))
                .append(newInput('武器攻击力'))
                .append(newInput('百分比攻击力', 0.1, true))
                .append(newInput('固定攻击力'));
        }

        function initQualityAdvanced(container) {
            container.append(newInput('暴击率', 0.1, true))
                .append(newInput('暴击伤害', 0.1, true));
        }

        function initQualityElemental(container) {
            container.append(newInput('物理伤害加成', 0.1, true))
                .append(newInput('元素伤害加成', 0.1, true))
                .append(newInput('元素影响增伤', 0.1, true))
                .append(newInput('造成伤害提高', 0.1, true));
        }

        function initCalculator(calculator) {
            initCalculatorAttack(calculator.children('fieldset.Attack'));
            initCalculatorDamageBonus(calculator.children('fieldset.DamageBonus'));
            initCalculatorCriticalBracket(calculator.children('fieldset.CriticalBracket'));
            initCalculatorFinalDamage(calculator.children('fieldset.FinalDamage'));
        }

        function initCalculatorAttack(container) {
            container.append(newRow()
                .append(newColumn('基础攻击力'))
                .append(symbol('='))
                .append(newColumn('人物攻击力'))
                .append(symbol('+'))
                .append(newColumn('武器攻击力'))
            ).append(newRow()
                .append(newColumn('额外攻击力'))
                .append(symbol('='))
                .append(newColumn('基础攻击力'))
                .append(symbol('×'))
                .append(newColumn('百分比攻击力', true))
                .append(symbol('+'))
                .append(newColumn('固定攻击力'))
            ).append(newRow()
                .append(newColumn('总攻击力'))
                .append(symbol('='))
                .append(newColumn('基础攻击力'))
                .append(symbol('+'))
                .append(newColumn('额外攻击力'))
            );
        }

        function initCalculatorDamageBonus(container) {
            container.append(newRow()
                .append(newColumn('伤害加成系数', true))
                .append(symbol('='))
                .append(symbol('1'))
                .append(symbol('+'))
                .append(symbol('('))
                .append(newColumn('物理伤害加成', true))
                .append(symbol('+'))
                .append(newColumn('元素伤害加成', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
                .append(symbol(')'))
            );
        }

        function initCalculatorCriticalBracket(container) {
            container.append(newRow()
                .append(newColumn('暴击收益', true))
                .append(symbol('='))
                .append(symbol('1'))
                .append(symbol('+'))
                .append(newColumn('暴击率', true))
                .append(symbol('×'))
                .append(newColumn('暴击伤害', true))
            );
        }

        function initCalculatorFinalDamage(container) {
            container.append(newRow()
                .append(newColumn('最终伤害'))
                .append(symbol('='))
                .append(newColumn('总攻击力'))
                .append(symbol('×'))
                .append(newColumn('伤害加成系数', true))
                .append(symbol('×'))
                .append(newColumn('暴击收益', true))
            )
        }

        $(function () {
            initQuality($('#quality'));
            initCalculator($('#calculator'));
            $('button[name=setup]').on('click', setupCheckpoint);
            $('button[name=delete]').on('click', deleteCheckpoint);
            $('button[name=reset]').on('click', resetCheckpoint);
        });
    </script>
</head>
<body>
<div id='main'>
    <div id='quality'>
        <fieldset class='Basis'>
            <legend>基础属性</legend>
        </fieldset>
        <fieldset class='Advanced'>
            <legend>进阶属性</legend>
        </fieldset>
        <fieldset class='Elemental'>
            <legend>元素属性</legend>
        </fieldset>
        <fieldset>
            <legend>比较基准</legend>
            <button name="setup">设置</button>
            <button name="delete">删除</button>
            <button name="reset">重置</button>
        </fieldset>
    </div>
    <div id='calculator'>
        <fieldset class='Attack'>
            <legend>基础区</legend>
        </fieldset>
        <fieldset class='DamageMultipiler'>
            <legend>倍率区</legend>
        </fieldset>
        <fieldset class='DamageBonus'>
            <legend>增伤区</legend>
        </fieldset>
        <fieldset class='CriticalBracket'>
            <legend>暴击区</legend>
        </fieldset>
        <fieldset class='ElementalReaction'>
            <legend>反应区</legend>
        </fieldset>
        <fieldset class='Defense'>
            <legend>防御区</legend>
        </fieldset>
        <fieldset class='Resistance'>
            <legend>抗性区</legend>
        </fieldset>
        <fieldset class='FinalDamage'>
            <legend>最终伤害</legend>
        </fieldset>
    </div>
</div>
</body>
</html>