<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>原神计算器</title>
    <link rel='stylesheet' href='https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/icon?family=Material+Icons'>
    <link rel='stylesheet' href='/ro/css/normalize.css'>
    <link rel='stylesheet' href='/ro/css/material-icons.css'>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://code.jquery.com/ui/1.13.1/jquery-ui.min.js'></script>
    <script src='/ro/js/common.js'></script>
    <style>
        html {
            font-size: 14px;
        }

        #main {
            display: flex;
            margin: 5px;
            column-gap: 5px;
        }

        #calculators {
            flex: 1;
        }

        div.input {
            display: flex;
            align-items: center;
            column-gap: 5px;
            margin: 1px;
        }

        div.input > label {
            flex-basis: 12ch;
            text-align: right;
        }

        div.row {
            display: flex;
            align-items: center;
            column-gap: 5px;
            margin: 2px;
        }

        div.column {
            flex-basis: 12ch;
        }

        div.column > label {
            display: block;
            text-align: center;
            font-size: 0.5em;
        }

        div.column > div {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        div.column > div > span:first-child {
            display: block;
            font-size: 1.2em;
        }

        div.column > div > span:last-child {
            display: block;
            font-size: 0.5em;
        }

        span[raise].up {
            color: red;
        }

        span[raise].down {
            color: green;
        }

    </style>
    <script>
        //剧变等级系数
        const upheavals = [
            9, 9, 10, 11, 11, 12, 13, 14, 16, 17,
            19, 20, 22, 24, 27, 30, 32, 35, 38, 40,
            43, 46, 49, 51, 54, 57, 59, 61, 65, 68,
            71, 75, 78, 81, 85, 88, 92, 96, 100, 104,
            108, 112, 117, 122, 128, 134, 141, 148, 155, 162,
            168, 175, 182, 189, 199, 208, 217, 226, 236, 246,
            257, 270, 283, 296, 312, 326, 340, 354, 368, 383,
            397, 412, 426, 439, 457, 473, 490, 506, 522, 539,
            555, 571, 588, 605, 627, 644, 663, 682, 703, 723
        ];

        const reactions = {
            bonus: {
                '火': {'蒸发': {target: '水', rate: 1.5}, '融化': {target: '冰', rate: 2}},
                '水': {'蒸发': {target: '火', rate: 2}},
                '冰': {'融化': {target: '火', rate: 1.5}}
            },
            upheaval: {
                rate: {'超导': 1, '扩散': 1.2, '碎冰': 3, '超载': 4, '感电': 2.4},
                '风': {'碎冰': ['冻'], '扩散': ['火', '水', '冰', '雷']},
                '雷': {'碎冰': ['冻'], '扩散': ['风'], '超导': ['冰'], '超载': ['火'], '感电': ['水']},
                '火': {'碎冰': ['冻'], '扩散': ['风'], '超载': ['雷']},
                '水': {'碎冰': ['冻'], '扩散': ['风'], '感电': ['雷']},
                '冰': {'碎冰': ['冻'], '扩散': ['风'], '超导': ['雷']},
                '岩': {'碎冰': ['冻']}
            }
        };

        function column(label, newValue) {
            if ('number' === typeof newValue) {
                $('span[column=\'' + label + '\']').each((_, span) => {
                    const percentage = true === $.data(span, 'percentage');
                    let value = newValue * (percentage ? 100 : 1);
                    $.data(span, 'value', value);

                    value = Math.round((value + Number.EPSILON) * 10000) / 10000;
                    const v1 = value + '';
                    const v2 = value.toFixed(percentage ? 2 : 0);
                    let displayValue = v1.length > v2.length ? v2 : v1;
                    $(span).text(displayValue + (percentage ? '%' : ''));

                    const checkpoint = $.data(span, 'checkpoint');
                    $(span).next('span[raise]').each((_, raise) => {
                        let displayRaise = '', classRaise = '';
                        if ('number' === typeof checkpoint) {
                            const raiseValue = Math.round((value - checkpoint + Number.EPSILON) * 10000) / 10000;
                            if (raiseValue != 0) {
                                classRaise = raiseValue > 0 ? 'up' : 'down';
                                if (checkpoint == 0) {
                                    displayRaise = raiseValue;
                                } else {
                                    const percentageValue = Math.round(((100 * raiseValue / checkpoint) + Number.EPSILON) * 10000) / 10000;
                                    displayRaise = percentageValue.toFixed(1) + '%';
                                }
                                displayRaise = (raiseValue > 0 ? '+' : '') + displayRaise;
                            }
                        }
                        $(raise).removeClass('up down').text(displayRaise).addClass(classRaise);
                    });
                });
                return newValue;
            } else {
                let value = false;
                let percentage = false;
                $('input[type=text][column=\'' + label + '\']').each((_, input) => {
                    value = $(input).val();
                    percentage = true === $.data(input, 'percentage');
                    return false;
                });
                if (false === value) {
                    $('select[column=\'' + label + '\']').each((_, input) => {
                        value = $(input).val();
                        percentage = true === $.data(input, 'percentage');
                        return false;
                    });
                }
                if (false === value) {
                    $('span[column=\'' + label + '\']').each((_, span) => {
                        value = $.data(span, 'value');
                        if ('number' !== typeof value) {
                            value = $(span).text();
                        }
                        percentage = true === $.data(span, 'percentage');
                        return false;
                    });
                }
                const num = parseFloat(value);
                return isNaN(num) ? 0.0 : num / (percentage ? 100 : 1);
            }
        }

        function calculate(attach) {
            const values = {};

            $('input[type=text][column]').each((_, input) => {
                const label = $(input).attr('column');
                values[label] = column(label);
            });
            $('select[column]').each((_, input) => {
                const label = $(input).attr('column');
                values[label] = column(label);
            });

            if ('object' === typeof attach) {
                Object.keys(attach).forEach((key) => {
                    const attachValue = attach[key];
                    if ('number' === typeof attachValue) {
                        const oldValue = values[key];
                        if ('number' === typeof oldValue) {
                            values[key] = oldValue + attachValue;
                        } else {
                            values[key] = attachValue;
                        }
                    }
                });
            }

            // 基础区
            values['基础攻击力'] = values['人物攻击力'] + values['武器攻击力'];
            values['额外攻击力'] = values['基础攻击力'] * values['攻击力%'] + values['固定攻击力'];
            values['总攻击力'] = values['基础攻击力'] + values['额外攻击力'];

            // 暴击区
            if (values['暴击率'] > 1) {
                values['暴击率'] = 1;
            }
            values['暴击收益'] = 1 + values['暴击率'] * values['暴击伤害'];
            values['暴伤倍率'] = 1 + values['暴击伤害'];

            // 防御区
            values['穿防系数'] = 1 - values['无视防御'];
            values['减防系数'] = 1 - values['防御减免'] + values['怪物防御%'];
            values['防御系数'] = values['穿防系数'] * values['减防系数'] * (values['怪物等级'] + 100);
            values['防御承伤'] = (values['人物等级'] + 100) / (values['人物等级'] + 100 + values['防御系数']);

            // 基础伤害
            values['基础伤害'] = values['总攻击力'] * values['防御承伤'];
            values['基础伤害(平均)'] = values['基础伤害'] * values['暴击收益'];
            values['基础伤害(暴击)'] = values['基础伤害'] * values['暴伤倍率'];

            // 增伤区
            values['普攻伤害加成'] = 1 + values['物理伤害%'] + values['普攻增伤'] + values['元素影响增伤'] + values['造成伤害提高'];
            values['重击伤害加成'] = 1 + values['物理伤害%'] + values['重击增伤'] + values['元素影响增伤'] + values['造成伤害提高'];
            values['附魔普攻伤害加成'] = 1 + values['元素伤害%'] + values['普攻增伤'] + values['元素影响增伤'] + values['造成伤害提高'];
            values['附魔重击伤害加成'] = 1 + values['元素伤害%'] + values['重击增伤'] + values['元素影响增伤'] + values['造成伤害提高'];
            values['元素战技伤害加成'] = 1 + values['元素伤害%'] + values['元素战技增伤'] + values['元素影响增伤'] + values['造成伤害提高'];
            values['元素爆发伤害加成'] = 1 + values['元素伤害%'] + values['元素爆发增伤'] + values['元素影响增伤'] + values['造成伤害提高'];

            // 抗性区
            const phyR = values['元素抗性'] = values['怪物元素抗性'] - values['元素抗性减免'];
            if (phyR > 0.75) {
                values['元素抗性承伤'] = 1 / (1 + 4 * phyR);
            } else if (phyR >= 0) {
                values['元素抗性承伤'] = 1 - phyR;
            } else {
                values['元素抗性承伤'] = 1 - phyR / 2;
            }
            const eleR = values['物理抗性'] = values['怪物物理抗性'] - values['物理抗性减免'];
            if (eleR > 0.75) {
                values['物理抗性承伤'] = 1 / (1 + 4 * eleR);
            } else if (eleR >= 0) {
                values['物理抗性承伤'] = 1 - eleR;
            } else {
                values['物理抗性承伤'] = 1 - eleR / 2;
            }

            // 技能伤害
            values['普攻伤害'] = values['基础伤害'] * values['普攻倍率'] * values['普攻伤害加成'] * values['物理抗性承伤'];
            values['普攻伤害(平均)'] = values['普攻伤害'] * values['暴击收益'];
            values['普攻伤害(暴击)'] = values['普攻伤害'] * values['暴伤倍率'];
            values['重击伤害'] = values['基础伤害'] * values['重击倍率'] * values['重击伤害加成'] * values['物理抗性承伤'];
            values['重击伤害(平均)'] = values['重击伤害'] * values['暴击收益'];
            values['重击伤害(暴击)'] = values['重击伤害'] * values['暴伤倍率'];
            values['附魔普攻伤害'] = values['基础伤害'] * values['普攻倍率'] * values['附魔普攻伤害加成'] * values['元素抗性承伤'];
            values['附魔普攻伤害(平均)'] = values['附魔普攻伤害'] * values['暴击收益'];
            values['附魔普攻伤害(暴击)'] = values['附魔普攻伤害'] * values['暴伤倍率'];
            values['附魔重击伤害'] = values['基础伤害'] * values['重击倍率'] * values['附魔重击伤害加成'] * values['元素抗性承伤'];
            values['附魔重击伤害(平均)'] = values['附魔重击伤害'] * values['暴击收益'];
            values['附魔重击伤害(暴击)'] = values['附魔重击伤害'] * values['暴伤倍率'];
            values['元素战技伤害'] = values['基础伤害'] * values['元素战技倍率'] * values['元素战技伤害加成'] * values['元素抗性承伤'];
            values['元素战技伤害(平均)'] = values['元素战技伤害'] * values['暴击收益'];
            values['元素战技伤害(暴击)'] = values['元素战技伤害'] * values['暴伤倍率'];
            values['元素爆发伤害'] = values['基础伤害'] * values['元素爆发倍率'] * values['元素爆发伤害加成'] * values['元素抗性承伤'];
            values['元素爆发伤害(平均)'] = values['元素爆发伤害'] * values['暴击收益'];
            values['元素爆发伤害(暴击)'] = values['元素爆发伤害'] * values['暴伤倍率'];

            // 增幅反应区
            values['增幅精通提升'] = (2.78 * values['元素精通']) / (values['元素精通'] + 1400);
            values['增幅反应倍率'] = 1 + values['增幅精通提升'] + values['反应系数提高'];

            // 剧变反应区
            values['剧变精通提升'] = 16 * values['元素精通'] / (values['元素精通'] + 2000);
            values['剧变反应倍率'] = 1 + values['剧变精通提升'] + values['反应伤害提升'];
            values['等级系数'] = upheavals[values['人物等级'] - 1];
            values['剧变基础伤害'] = values['等级系数'] * values['元素抗性承伤'] * values['剧变反应倍率'];

            // 反应伤害
            const element = $('select[column=元素类型]').val();
            const bonus = reactions.bonus[element];
            if ('object' === typeof bonus) {
                Object.keys(bonus).forEach((key) => {
                    values['附魔普攻伤害(' + key + ')'] = values['附魔普攻伤害'] * values['增幅反应倍率'] * bonus[key].rate;
                    values['附魔重击伤害(' + key + ')'] = values['附魔重击伤害'] * values['增幅反应倍率'] * bonus[key].rate;
                    values['元素战技伤害(' + key + ')'] = values['元素战技伤害'] * values['增幅反应倍率'] * bonus[key].rate;
                    values['元素爆发伤害(' + key + ')'] = values['元素爆发伤害'] * values['增幅反应倍率'] * bonus[key].rate;
                    values['附魔普攻伤害(' + key.substr(0, 1) + '暴)'] = values['附魔普攻伤害(' + key + ')'] * values['暴伤倍率'];
                    values['附魔重击伤害(' + key.substr(0, 1) + '暴)'] = values['附魔重击伤害(' + key + ')'] * values['暴伤倍率'];
                    values['元素战技伤害(' + key.substr(0, 1) + '暴)'] = values['元素战技伤害(' + key + ')'] * values['暴伤倍率'];
                    values['元素爆发伤害(' + key.substr(0, 1) + '暴)'] = values['元素爆发伤害(' + key + ')'] * values['暴伤倍率'];
                });
            }
            const upheaval = reactions.upheaval[element];
            if ('object' === typeof upheaval) {
                Object.keys(upheaval).forEach((key) => {
                    values['剧变伤害(' + key + ')'] = values['剧变基础伤害'] * reactions.upheaval.rate[key];
                });
            }

            return values;
        }

        function calc(attach) {
            const values = calculate(attach);
            $('span[column]').each((_, span) => {
                const label = $(span).attr('column');
                column(label, values[label]);
            });
            const phyR = values['物理抗性'], eleR = values['元素抗性'];
            const rows = $('fieldset.calculator-resistance').children('div[optional].row').hide();
            rows.eq(phyR > 0.75 ? 0 : (phyR >= 0 ? 1 : 2)).show();
            rows.eq(eleR > 0.75 ? 3 : (eleR >= 0 ? 4 : 5)).show();
        }

        function setupCheckpoint() {
            $('span[column]').each((_, span) => {
                const value = $.data(span, 'value');
                if ('number' === typeof value) {
                    $.data(span, 'checkpoint', value);
                }
            });
            $('input[type=text][column]').each((_, input) => {
                const value = $(input).val();
                $.data(input, 'checkpoint', value);
            });
            calc();
        }

        function deleteCheckpoint() {
            $('span[column]').each((_, span) => {
                $.removeData(span, 'checkpoint');
            });
            $('input[type=text][column]').each((_, input) => {
                $.removeData(input, 'checkpoint');
            });
            calc();
        }

        function resetCheckpoint() {
            $('input[type=text][column]').each((_, input) => {
                const value = $.data(input, 'checkpoint');
                if ('string' === typeof value) {
                    $(input).val(value);
                }
            });
            calc();
        }

        function newRow() {
            return $.html.div().addClass('row');
        }

        function newColumn(label, percentage = false) {
            const column = $.html.div().addClass('column')
                .append($.html.div()
                    .append($.html.span({column: label}).text(true === percentage ? '0%' : '0'))
                    .append($.html.span({raise: label})))
                .append($.html.label().text(label));
            if (true === percentage) {
                $('span[column]', column).each((_, span) => {
                    $.data(span, 'percentage', percentage);
                });
            }
            return column;
        }

        function newInput(label, step = 1, percentage = false, min = 0, max = 0, current = 0) {
            const input = $.html.div().addClass('input')
                .append($.html.label().text(label))
                .append($.html.input({type: 'text', column: label, size: 5}));
            input.children('input[type=text]').each((_, input) => {
                if (step != 1) {
                    $.data(input, 'step', step);
                }
                if (true === percentage) {
                    $.data(input, 'percentage', percentage);
                }
                if ('number' === typeof min && min !== 0) {
                    $.data(input, 'min', min);
                }
                if ('number' === typeof max && max > 0) {
                    $.data(input, 'max', max);
                }
                if ('number' === typeof current && current > 0) {
                    $.data(input, 'current', current);
                }
            });
            return input;
        }

        function newSelect(label, options, percentage = false, current = 0) {
            const select = $.html.select({column: label}).each((_, select) => {
                if (true === percentage) {
                    $.data(select, 'percentage', percentage);
                }
                if ('number' === typeof current && current > 0) {
                    $.data(select, 'current', current);
                }
            });
            Object.keys(options).forEach((key) => {
                select.append($.html.option({value: options[key]}, key));
            });
            return $.html.div().addClass('input')
                .append($.html.label().text(label))
                .append(select);
        }

        function symbol() {
            if (arguments.length === 1) {
                return $.html.div().addClass('symbol').text(arguments[0]);
            } else {
                const symbols = [];
                Array.from(arguments).forEach((symbol) => {
                    symbols.push($.html.div().addClass('symbol').text(symbol));
                });
                return symbols;
            }
        }

        function initQuality() {
            initQualityBasis($('fieldset.quality-basis'));
            initQualityCritical($('fieldset.quality-critical'));
            initQualityDefence($('fieldset.quality-defence'));

            initQualityDamage($('fieldset.quality-damage'));
            initQualitySkillMultiplier($('fieldset.quality-skill-multiplier'));
            initQualityResistance($('fieldset.quality-resistance'));

            initQualityReaction($('fieldset.quality-reaction'));

            $('input[type=text][column]').each((_, input) => {
                const min = $.data(input, 'min') || 0;
                const current = $.data(input, 'current');
                $(input).spinner({
                    numberFormat: 'n',
                    step: $.data(input, 'step') || 1,
                    min: min,
                    max: $.data(input, 'max') || null,
                    spin: calc
                }).spinner('value', 'number' === typeof current ? current : min).on('spinchange', calc);
            }).on('focus', function () {
                $(this).trigger('select');
            });
            $('select[column]').selectmenu({
                width: 75,
                change: calc
            });
        }

        function initQualityBasis(container) {
            container.append(newInput('人物等级', 1, false, 1, 90, 90))
                .append(newInput('人物攻击力', 1, false, 0, false, 100))
                .append(newInput('武器攻击力'))
                .append(newInput('攻击力%', 0.1, true))
                .append(newInput('固定攻击力'));
        }

        function initQualityCritical(container) {
            container.append(newInput('暴击率', 0.1, true, 0, false, 5))
                .append(newInput('暴击伤害', 0.1, true, 0, false, 50));
        }

        function initQualityDefence(container) {
            container.append(newInput('无视防御', 0.1, true))
                .append(newInput('防御减免', 0.1, true))
                .append(newInput('怪物防御%', 0.1, true))
                .append(newInput('怪物等级', 1, false, 1, 90, 90));
        }

        function initQualityDamage(container) {
            container.append(newInput('物理伤害%', 0.1, true))
                .append(newInput('元素伤害%', 0.1, true))
                .append(newInput('元素影响增伤', 0.1, true))
                .append(newInput('造成伤害提高', 0.1, true))
                .append(newInput('普攻增伤', 0.1, true))
                .append(newInput('重击增伤', 0.1, true))
                .append(newInput('元素战技增伤', 0.1, true))
                .append(newInput('元素爆发增伤', 0.1, true));
        }

        function initQualitySkillMultiplier(container) {
            container.append(newInput('普攻倍率', 0.1, true, 0, false, 50))
                .append(newInput('重击倍率', 0.1, true, 0, false, 100))
                .append(newInput('元素战技倍率', 0.1, true, 0, false, 150))
                .append(newInput('元素爆发倍率', 0.1, true, 0, false, 250));
        }

        function initQualityResistance(container) {
            container.append(newInput('物理抗性减免', 1, true))
                .append(newInput('元素抗性减免', 1, true))
                .append(newInput('怪物物理抗性', 1, true, -100, 0, 10))
                .append(newInput('怪物元素抗性', 1, true, -100, 0, 10));
        }

        function initQualityReaction(container) {
            container.append(newInput('元素精通'))
                .append(newInput('反应系数提高', 1, true))
                .append(newInput('反应伤害提升', 1, true))
                .append(newSelect('元素类型', {'火': '火', '水': '水', '冰': '冰', '岩': '岩', '风': '风', '雷': '雷'}));
            const initDamageReaction = function () {
                initCalculatorDamageReaction($('fieldset.calculator-damage-reaction'), $(this).val());
            };
            $('select[column=元素类型]', container).on("selectmenucreate", initDamageReaction).on("selectmenuchange", initDamageReaction);
        }

        function initCalculator() {
            initCalculatorAttack($('fieldset.calculator-attack'));
            initCalculatorCritical($('fieldset.calculator-critical'));
            initCalculatorDefense($('fieldset.calculator-defense'));
            initCalculatorDamageBasic($('fieldset.calculator-damage-basic'));

            initCalculatorDamageBonus($('fieldset.calculator-damage-bonus'));
            initCalculatorResistance($('fieldset.calculator-resistance'));
            initCalculatorDamageSkill($('fieldset.calculator-damage-skill'));

            initCalculatorReactionBonus($('fieldset.calculator-reaction-bonus'));
            initCalculatorReactionUpheaval($('fieldset.calculator-reaction-upheaval'));
        }

        function initCalculatorAttack(container) {
            container.append(newRow()
                .append(newColumn('基础攻击力'))
                .append(symbol('='))
                .append(newColumn('人物攻击力'))
                .append(symbol('+'))
                .append(newColumn('武器攻击力'))
            ).append(newRow()
                .append(newColumn('额外攻击力'))
                .append(symbol('='))
                .append(newColumn('基础攻击力'))
                .append(symbol('×'))
                .append(newColumn('攻击力%', true))
                .append(symbol('+'))
                .append(newColumn('固定攻击力'))
            ).append(newRow()
                .append(newColumn('总攻击力'))
                .append(symbol('='))
                .append(newColumn('基础攻击力'))
                .append(symbol('+'))
                .append(newColumn('额外攻击力'))
            );
        }

        function initCalculatorCritical(container) {
            container.append(newRow()
                .append(newColumn('暴击收益', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('暴击率', true))
                .append(symbol('×'))
                .append(newColumn('暴击伤害', true))
            ).append(newRow()
                .append(newColumn('暴伤倍率', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('暴击伤害', true))
            );
        }

        function initCalculatorDefense(container) {
            container.append(newRow()
                .append(newColumn('穿防系数', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('无视防御', true))
            ).append(newRow()
                .append(newColumn('减防系数', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('防御减免', true))
                .append(symbol('+'))
                .append(newColumn('怪物防御%', true))
            ).append(newRow()
                .append(newColumn('防御系数'))
                .append(symbol('='))
                .append(newColumn('穿防系数', true))
                .append(symbol('×'))
                .append(newColumn('减防系数', true))
                .append(symbol('×'), '(')
                .append(newColumn('怪物等级'))
                .append(symbol('+', '100', ')'))
            ).append(newRow()
                .append(newColumn('防御承伤', true))
                .append(symbol('='), '(')
                .append(newColumn('人物等级'))
                .append(symbol('+', '100', ')', '/', '('))
                .append(newColumn('人物等级'))
                .append(symbol('+', '100', '+'))
                .append(newColumn('防御系数'))
                .append(symbol(')'))
            );
        }

        function initCalculatorDamageBasic(container) {
            container.append(newRow()
                .append(newColumn('基础伤害'))
                .append(symbol('='))
                .append(newColumn('总攻击力'))
                .append(symbol('×'))
                .append(newColumn('防御承伤', true))
            ).append(newRow()
                .append(newColumn('基础伤害(平均)'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('暴击收益', true))
            ).append(newRow()
                .append(newColumn('基础伤害(暴击)'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('暴伤倍率', true))
            );
        }

        function initCalculatorDamageBonus(container) {
            container.append(newRow()
                .append(newColumn('普攻伤害加成', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('物理伤害%', true))
                .append(symbol('+'))
                .append(newColumn('普攻增伤', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
            ).append(newRow()
                .append(newColumn('重击伤害加成', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('物理伤害%', true))
                .append(symbol('+'))
                .append(newColumn('重击增伤', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
            ).append(newRow()
                .append(newColumn('附魔普攻伤害加成', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('元素伤害%', true))
                .append(symbol('+'))
                .append(newColumn('普攻增伤', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
            ).append(newRow()
                .append(newColumn('附魔重击伤害加成', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('元素伤害%', true))
                .append(symbol('+'))
                .append(newColumn('重击增伤', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
            ).append(newRow()
                .append(newColumn('元素战技伤害加成', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('元素伤害%', true))
                .append(symbol('+'))
                .append(newColumn('元素战技增伤', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
            ).append(newRow()
                .append(newColumn('元素爆发伤害加成', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('元素伤害%', true))
                .append(symbol('+'))
                .append(newColumn('元素爆发增伤', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
            );
        }

        function initCalculatorResistance(container) {
            container.append(newRow()
                .append(newColumn('物理抗性', true))
                .append(symbol('='))
                .append(newColumn('怪物物理抗性', true))
                .append(symbol('-'))
                .append(newColumn('物理抗性减免', true))
                .append(symbol(' '))
                .append(newColumn('元素抗性', true))
                .append(symbol('='))
                .append(newColumn('怪物元素抗性', true))
                .append(symbol('-'))
                .append(newColumn('元素抗性减免', true))
            ).append(newRow().attr('optional', true)
                .append(newColumn('物理抗性承伤', true))
                .append(symbol('=', '1', '/', '(1', '+', '4', '×'))
                .append(newColumn('物理抗性', true))
                .append(symbol(')'))
            ).append(newRow().attr('optional', true)
                .append(newColumn('物理抗性承伤', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('物理抗性', true))
            ).append(newRow().attr('optional', true)
                .append(newColumn('物理抗性承伤', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('物理抗性', true))
                .append(symbol('/', '2'))
            ).append(newRow().attr('optional', true)
                .append(newColumn('元素抗性承伤', true))
                .append(symbol('=', '1', '/', '(1', '+', '4', '×'))
                .append(newColumn('元素抗性', true))
                .append(symbol(')'))
            ).append(newRow().attr('optional', true)
                .append(newColumn('元素抗性承伤', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('元素抗性', true))
            ).append(newRow().attr('optional', true)
                .append(newColumn('元素抗性承伤', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('元素抗性', true))
                .append(symbol('/', '2'))
            );
        }

        function initCalculatorDamageSkill(container) {
            container.append(newRow()
                .append(newColumn('普攻伤害'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('普攻倍率', true))
                .append(symbol('×'))
                .append(newColumn('普攻伤害加成', true))
                .append(symbol('×'))
                .append(newColumn('物理抗性承伤', true))
                .append(symbol(' '))
                .append(newColumn('普攻伤害(平均)'))
                .append(symbol(' '))
                .append(newColumn('普攻伤害(暴击)'))
            ).append(newRow()
                .append(newColumn('重击伤害'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('重击倍率', true))
                .append(symbol('×'))
                .append(newColumn('重击伤害加成', true))
                .append(symbol('×'))
                .append(newColumn('物理抗性承伤', true))
                .append(symbol(' '))
                .append(newColumn('重击伤害(平均)'))
                .append(symbol(' '))
                .append(newColumn('重击伤害(暴击)'))
            ).append(newRow()
                .append(newColumn('附魔普攻伤害'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('普攻倍率', true))
                .append(symbol('×'))
                .append(newColumn('附魔普攻伤害加成', true))
                .append(symbol('×'))
                .append(newColumn('元素抗性承伤', true))
                .append(symbol(' '))
                .append(newColumn('附魔普攻伤害(平均)'))
                .append(symbol(' '))
                .append(newColumn('附魔普攻伤害(暴击)'))
            ).append(newRow()
                .append(newColumn('附魔重击伤害'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('重击倍率', true))
                .append(symbol('×'))
                .append(newColumn('附魔重击伤害加成', true))
                .append(symbol('×'))
                .append(newColumn('元素抗性承伤', true))
                .append(symbol(' '))
                .append(newColumn('附魔重击伤害(平均)'))
                .append(symbol(' '))
                .append(newColumn('附魔重击伤害(暴击)'))
            ).append(newRow()
                .append(newColumn('元素战技伤害'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('元素战技倍率', true))
                .append(symbol('×'))
                .append(newColumn('元素战技伤害加成', true))
                .append(symbol('×'))
                .append(newColumn('元素抗性承伤', true))
                .append(symbol(' '))
                .append(newColumn('元素战技伤害(平均)'))
                .append(symbol(' '))
                .append(newColumn('元素战技伤害(暴击)'))
            ).append(newRow()
                .append(newColumn('元素爆发伤害'))
                .append(symbol('='))
                .append(newColumn('基础伤害'))
                .append(symbol('×'))
                .append(newColumn('元素爆发倍率', true))
                .append(symbol('×'))
                .append(newColumn('元素爆发伤害加成', true))
                .append(symbol('×'))
                .append(newColumn('元素抗性承伤', true))
                .append(symbol(' '))
                .append(newColumn('元素爆发伤害(平均)'))
                .append(symbol(' '))
                .append(newColumn('元素爆发伤害(暴击)'))
            );
        }

        function initCalculatorReactionBonus(container) {
            container.append(newRow()
                .append(newColumn('增幅精通提升', true))
                .append(symbol('=', '(', '2.78', '×'))
                .append(newColumn('元素精通'))
                .append(symbol(')', '/', '('))
                .append(newColumn('元素精通'))
                .append(symbol('+', '1400', ')'))
            ).append(newRow()
                .append(newColumn('增幅反应倍率', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('增幅精通提升', true))
                .append(symbol('+'))
                .append(newColumn('反应系数提高', true))
            );
        }

        function initCalculatorReactionUpheaval(container) {
            container.append(newRow()
                .append(newColumn('剧变精通提升', true))
                .append(symbol('=', '16', '×'))
                .append(newColumn('元素精通'))
                .append(symbol('/', '('))
                .append(newColumn('元素精通'))
                .append(symbol('+', '2000', ')'))
            ).append(newRow()
                .append(newColumn('剧变反应倍率', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('剧变精通提升', true))
                .append(symbol('+'))
                .append(newColumn('反应伤害提升', true))
            ).append(newRow()
                .append(newColumn('剧变基础伤害'))
                .append(symbol('='))
                .append(newColumn('等级系数'))
                .append(symbol('×'))
                .append(newColumn('元素抗性承伤', true))
                .append(symbol('×'))
                .append(newColumn('剧变反应倍率', true))
            );
        }

        function initCalculatorDamageReactionRow(container, element, label) {
            const bonus = reactions.bonus[element];
            if ('object' === typeof bonus) {
                const row = newRow();
                if (label.startsWith('附魔')) {
                    row.append(newColumn(label.substr(2))).append(symbol(' '));
                }
                row.append(newColumn(label)).append(symbol(' ')).append(newColumn(label + '(暴击)'));
                Object.keys(bonus).forEach((key) => {
                    row.append(symbol(' ')).append(newColumn(label + '(' + key + ')'));
                    row.append(symbol(' ')).append(newColumn(label + '(' + key.substr(0, 1) + '暴)'));
                });
                container.append(row);
            }
        }

        function initCalculatorDamageReaction(container, element) {
            container.children('div.row').remove();
            initCalculatorDamageReactionRow(container, element, '附魔普攻伤害');
            initCalculatorDamageReactionRow(container, element, '附魔重击伤害');
            initCalculatorDamageReactionRow(container, element, '元素战技伤害');
            initCalculatorDamageReactionRow(container, element, '元素爆发伤害');

            const upheaval = reactions.upheaval[element];
            if ('object' === typeof upheaval) {
                const row = newRow();
                Object.keys(upheaval).forEach((key, index) => {
                    if (index > 0) {
                        row.append(symbol(' '));
                    }
                    row.append(newColumn('剧变伤害(' + key + ')'));
                });
                container.append(row);
            }
        }

        function initWeight() {
            $('.Weight')
                .append($.html.button({}, '设置').on('click', setupCheckpoint))
                .append($.html.button({}, '删除').on('click', deleteCheckpoint))
                .append($.html.button({}, '重置').on('click', resetCheckpoint))
                .append($.html.button({}, '攻击力%').on('click', () => {
                    calc({'攻击力%': 0.466});
                }))
                .append($.html.button({}, '固定攻击力').on('click', () => {
                    calc({'固定攻击力': 311});
                }))
                .append($.html.button({}, '物理伤害%').on('click', () => {
                    calc({'物理伤害%': 0.583});
                }))
                .append($.html.button({}, '元素伤害%').on('click', () => {
                    calc({'元素伤害%': 0.466});
                }))
                .append($.html.button({}, '暴击率').on('click', () => {
                    calc({'暴击率': 0.311});
                }))
                .append($.html.button({}, '暴击伤害').on('click', () => {
                    calc({'暴击伤害': 0.622});
                }))
                .append($.html.button({}, '元素精通').on('click', () => {
                    calc({'元素精通': 187});
                }))
                .append($.html.button({}, '超导').on('click', () => {
                    calc({'物理抗性减免': 0.4});
                }))
            ;
        }

        $(function () {
            const calculators = $('#calculators').tabs();
            const qualities = $('#qualities').tabs({
                activate: function () {
                    calculators.tabs("option", "active", qualities.tabs("option", "active"));
                }
            });
            initQuality();
            initCalculator();
            initWeight();
            calc();
        });
    </script>
</head>
<body>
<div class="Weight"></div>
<div id='main'>
    <div id="qualities">
        <ul>
            <li><a href="#quality1">基础</a></li>
            <li><a href="#quality2">技能</a></li>
            <li><a href="#quality3">反应</a></li>
        </ul>
        <div id="quality1">
            <fieldset class='quality-basis'>
                <legend>基础属性</legend>
            </fieldset>
            <fieldset class='quality-critical'>
                <legend>暴击属性</legend>
            </fieldset>
            <fieldset class='quality-defence'>
                <legend>防御属性</legend>
            </fieldset>
        </div>
        <div id="quality2">
            <fieldset class='quality-damage'>
                <legend>增伤属性</legend>
            </fieldset>
            <fieldset class='quality-skill-multiplier'>
                <legend>技能倍率</legend>
            </fieldset>
            <fieldset class='quality-resistance'>
                <legend>抗性属性</legend>
            </fieldset>
        </div>
        <div id="quality3">
            <fieldset class='quality-reaction'>
                <legend>元素反应属性</legend>
            </fieldset>
        </div>
    </div>
    <div id="calculators">
        <ul>
            <li><a href="#calculator1">基础伤害</a></li>
            <li><a href="#calculator2">技能伤害</a></li>
            <li><a href="#calculator3">反应伤害</a></li>
        </ul>
        <div id='calculator1'>
            <fieldset class='calculator-attack'>
                <legend>基础区</legend>
            </fieldset>
            <fieldset class='calculator-critical'>
                <legend>暴击区</legend>
            </fieldset>
            <fieldset class='calculator-defense'>
                <legend>防御区</legend>
            </fieldset>
            <fieldset class='calculator-damage-basic'>
                <legend>基础伤害</legend>
            </fieldset>
        </div>
        <div id='calculator2'>
            <fieldset class='calculator-damage-bonus'>
                <legend>增伤区</legend>
            </fieldset>
            <fieldset class='calculator-resistance'>
                <legend>抗性区</legend>
            </fieldset>
            <fieldset class='calculator-damage-skill'>
                <legend>技能伤害</legend>
            </fieldset>
        </div>
        <div id='calculator3'>
            <fieldset class='calculator-reaction-bonus'>
                <legend>增幅反应区</legend>
            </fieldset>
            <fieldset class='calculator-reaction-upheaval'>
                <legend>剧变反应区</legend>
            </fieldset>
            <fieldset class='calculator-damage-reaction'>
                <legend>反应伤害</legend>
            </fieldset>
        </div>
    </div>
</div>
</body>
</html>