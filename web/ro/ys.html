<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>原神计算器</title>
    <link rel='stylesheet' href='https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/icon?family=Material+Icons'>
    <link rel='stylesheet' href='/ro/css/normalize.css'>
    <link rel='stylesheet' href='/ro/css/material-icons.css'>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://code.jquery.com/ui/1.13.1/jquery-ui.min.js'></script>
    <script src='/ro/js/jform/jform.min.js'></script>
    <script src='/ro/js/jsonpath-0.8.0.js'></script>
    <script src='/ro/js/common.js'></script>
    <script src='/ro/js/dialog.js'></script>
    <style>
        html {
            font-size: 14px;
        }

        #main {
            display: flex;
            margin: 5px;
            column-gap: 5px;
        }

        #main > #quality1 {
            flex: 1;
        }

        #main > #quality2 {
            flex: 1;
        }

        #main > #calculator1 {
            flex: 2;
        }

        #main > #calculator2 {
            flex: 2.5;
        }

        div.row {
            display: flex;
            align-items: center;
            column-gap: 5px;
            margin: 5px;
        }

        div.column:first-child {
            flex-basis: 8ch;
        }

        div.column > label {
            display: block;
            text-align: center;
            font-size: 0.5em;
        }

        div.column > div {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        div.column > div > span:first-child {
            display: block;
            font-size: 1.2em;
        }

        div.column > div > span:last-child {
            display: block;
            font-size: 0.5em;
        }

        span[raise].up {
            color: red;
        }

        span[raise].down {
            color: green;
        }

        div.input {
            display: flex;
            align-items: center;
            column-gap: 5px;
            margin: 2px;
        }

        div.input > label {
            flex-basis: 12ch;
            text-align: right;
        }
    </style>
    <script>
        function column(label, newValue) {
            if ('number' === typeof newValue) {
                $('span[column=\'' + label + '\']').each((_, span) => {
                    const percentage = true === $.data(span, 'percentage');
                    let value = newValue * (percentage ? 100 : 1);
                    $.data(span, 'value', value);

                    value = Math.round((value + Number.EPSILON) * 10000) / 10000;
                    const v1 = value + '';
                    const v2 = value.toFixed(percentage ? 2 : 0);
                    let displayValue = v1.length > v2.length ? v2 : v1;
                    $(span).text(displayValue + (percentage ? '%' : ''));

                    const checkpoint = $.data(span, 'checkpoint');
                    $(span).next('span[raise]').each((_, raise) => {
                        let displayRaise = '', classRaise = '';
                        if ('number' === typeof checkpoint) {
                            const raiseValue = Math.round((value - checkpoint + Number.EPSILON) * 10000) / 10000;
                            if (raiseValue != 0) {
                                classRaise = raiseValue > 0 ? 'up' : "down";
                                if (checkpoint == 0) {
                                    displayRaise = raiseValue;
                                } else {
                                    const percentageValue = Math.round(((100 * raiseValue / checkpoint) + Number.EPSILON) * 10000) / 10000;
                                    displayRaise = percentageValue.toFixed(1) + '%';
                                }
                                displayRaise = (raiseValue > 0 ? '+' : '') + displayRaise;
                            }
                        }
                        $(raise).removeClass('up down').text(displayRaise).addClass(classRaise);
                    });
                });
                return newValue;
            } else {
                let value = false;
                let percentage = false;
                $('input[type=text][column=\'' + label + '\']').each((_, input) => {
                    value = $(input).val();
                    percentage = true === $.data(input, 'percentage');
                    return false;
                });
                if (false === value) {
                    $('span[column=\'' + label + '\']').each((_, span) => {
                        value = $.data(span, 'value');
                        if ('number' !== typeof value) {
                            value = $(span).text();
                        }
                        percentage = true === $.data(span, 'percentage');
                        return false;
                    });
                }
                const num = parseFloat(value);
                return isNaN(num) ? 0.0 : num / (percentage ? 100 : 1);
            }
        }

        function calc() {
            $('input[type=text][column]').each((_, input) => {
                const label = $(input).attr('column');
                column(label, column(label));
            });

            column('基础攻击力', column('人物攻击力') + column('武器攻击力'));
            column('额外攻击力', column('基础攻击力') * column('百分比攻击力') + column('固定攻击力'));
            column('总攻击力', column('基础攻击力') + column('额外攻击力'));

            column('伤害加成系数', 1 + column('物理伤害加成') + column('元素伤害加成') + column('元素影响增伤') + column('造成伤害提高'));

            column('暴击收益', 1 + column('暴击率') * column('暴击伤害'));

            column('穿防系数', 1 - column('无视防御'));
            column('减防系数', 1 - column('防御减免') + column('怪物防御增加'));
            column('防御系数', column('穿防系数') * column('减防系数') * (column('怪物等级') + 100));
            column('防御对象承伤', (column('人物等级') + 100) / (column('人物等级') + 100 + column('防御系数')));

            const R = column('元素抗性', column('怪物抗性') - column('元素抗性减免'));
            const resistanceRows = $('#calculator1').children('fieldset.Resistance').children('div[optional].row').hide();
            if (R > 0.75) {
                column('抗性对象承伤', 1 / (1 + 4 * R));
                resistanceRows.eq(0).show();
            } else if (R >= 0) {
                column('抗性对象承伤', 1 - R);
                resistanceRows.eq(1).show();
            } else {
                column('抗性对象承伤', 1 - R / 2);
                resistanceRows.eq(2).show();
            }

            column('最终伤害', column('总攻击力') * column('伤害加成系数') * column('暴击收益') * column('防御对象承伤') * column('抗性对象承伤'));
        }

        function setupCheckpoint() {
            $('span[column]').each((_, span) => {
                const value = $.data(span, 'value');
                if ('number' === typeof value) {
                    $.data(span, 'checkpoint', value);
                }
            });
            $('input[type=text][column]').each((_, input) => {
                const value = $(input).val();
                $.data(input, 'checkpoint', value);
            });
            calc();
        }

        function deleteCheckpoint() {
            $('span[column]').each((_, span) => {
                $.removeData(span, 'checkpoint');
            });
            $('input[type=text][column]').each((_, input) => {
                $.removeData(input, 'checkpoint');
            });
            calc();
        }

        function resetCheckpoint() {
            $('input[type=text][column]').each((_, input) => {
                const value = $.data(input, 'checkpoint');
                if ('string' === typeof value) {
                    $(input).val(value);
                }
            });
            calc();
        }

        function newRow() {
            return $.html.div().addClass('row');
        }

        function newColumn(label, percentage = false) {
            const column = $.html.div().addClass('column')
                .append($.html.div()
                    .append($.html.span({column: label}).text(true === percentage ? '0%' : '0'))
                    .append($.html.span({raise: label})))
                .append($.html.label().text(label));
            if (true === percentage) {
                $('span[column]', column).each((_, span) => {
                    $.data(span, 'percentage', percentage);
                });
            }
            return column;
        }

        function newInput(label, step = 1, percentage = false, min = 0, max = 0, current = 0) {
            const input = $.html.div().addClass('input')
                .append($.html.label().text(label))
                .append($.html.input({type: 'text', column: label, size: 5}));
            input.children('input[type=text]').each((_, input) => {
                if (step != 1) {
                    $.data(input, 'step', step);
                }
                if (true === percentage) {
                    $.data(input, 'percentage', percentage);
                }
                if ('number' === typeof min && min !== 0) {
                    $.data(input, 'min', min);
                }
                if ('number' === typeof max && max > 0) {
                    $.data(input, 'max', max);
                }
                if ('number' === typeof current && current > 0) {
                    $.data(input, 'current', current);
                }
            });
            return input;
        }

        function symbol() {
            if (arguments.length === 1) {
                return $.html.div().addClass('symbol').text(arguments[0]);
            } else {
                const symbols = [];
                Array.from(arguments).forEach((symbol) => {
                    symbols.push($.html.div().addClass('symbol').text(symbol));
                });
                return symbols;
            }
        }

        function initQualityInput(quality) {
            quality.find('input[type=text]').each((_, input) => {
                const min = $.data(input, 'min') || 0;
                const current = $.data(input, 'current');
                $(input).spinner({
                    numberFormat: 'n',
                    step: $.data(input, 'step') || 1,
                    min: min,
                    max: $.data(input, 'max') || null,
                    spin: calc
                }).spinner('value', 'number' === typeof current ? current : min).on("spinchange", calc);
            }).on('focus', function () {
                $(this).trigger('select');
            });
        }

        function initQuality(quality1, quality2) {
            initQualityBase(quality1.children('fieldset.Basis'));
            initQualityAdvanced(quality2.children('fieldset.Advanced'));
            initQualityElemental(quality1.children('fieldset.Elemental'));
            initQualityOther(quality2.children('fieldset.Other'));
            initQualityInput(quality1);
            initQualityInput(quality2);
        }

        function initQualityBase(container) {
            container.append(newInput('人物攻击力'))
                .append(newInput('武器攻击力'))
                .append(newInput('百分比攻击力', 0.1, true))
                .append(newInput('固定攻击力'));
        }

        function initQualityAdvanced(container) {
            container.append(newInput('暴击率', 0.1, true))
                .append(newInput('暴击伤害', 0.1, true))
                .append(newInput('无视防御', 0.1, true))
                .append(newInput('防御减免', 0.1, true));
        }

        function initQualityElemental(container) {
            container.append(newInput('物理伤害加成', 0.1, true))
                .append(newInput('元素伤害加成', 0.1, true))
                .append(newInput('元素影响增伤', 0.1, true))
                .append(newInput('造成伤害提高', 0.1, true))
                .append(newInput('元素抗性减免', 1, true));
        }

        function initQualityOther(container) {
            container.append(newInput('人物等级', 1, false, 1, 90, 90))
                .append(newInput('怪物等级', 1, false, 1, 90, 90))
                .append(newInput('怪物防御增加', 0.1, true))
                .append(newInput('怪物抗性', 1, true, -100, 0, 10));
        }

        function initCalculator(calculator1, calculator2) {
            initCalculatorAttack(calculator1.children('fieldset.Attack'));
            initCalculatorDamageBonus(calculator2.children('fieldset.DamageBonus'));
            initCalculatorCriticalBracket(calculator1.children('fieldset.CriticalBracket'));
            initCalculatorDefense(calculator2.children('fieldset.Defense'));
            initCalculatorResistance(calculator1.children('fieldset.Resistance'));
            initCalculatorFinalDamage(calculator2.children('fieldset.FinalDamage'));
        }

        function initCalculatorAttack(container) {
            container.append(newRow()
                .append(newColumn('基础攻击力'))
                .append(symbol('='))
                .append(newColumn('人物攻击力'))
                .append(symbol('+'))
                .append(newColumn('武器攻击力'))
            ).append(newRow()
                .append(newColumn('额外攻击力'))
                .append(symbol('='))
                .append(newColumn('基础攻击力'))
                .append(symbol('×'))
                .append(newColumn('百分比攻击力', true))
                .append(symbol('+'))
                .append(newColumn('固定攻击力'))
            ).append(newRow()
                .append(newColumn('总攻击力'))
                .append(symbol('='))
                .append(newColumn('基础攻击力'))
                .append(symbol('+'))
                .append(newColumn('额外攻击力'))
            );
        }

        function initCalculatorDamageBonus(container) {
            container.append(newRow()
                .append(newColumn('伤害加成系数', true))
                .append(symbol('=', '1', '+', '('))
                .append(newColumn('物理伤害加成', true))
                .append(symbol('+'))
                .append(newColumn('元素伤害加成', true))
                .append(symbol('+'))
                .append(newColumn('元素影响增伤', true))
                .append(symbol('+'))
                .append(newColumn('造成伤害提高', true))
                .append(symbol(')'))
            );
        }

        function initCalculatorCriticalBracket(container) {
            container.append(newRow()
                .append(newColumn('暴击收益', true))
                .append(symbol('=', '1', '+'))
                .append(newColumn('暴击率', true))
                .append(symbol('×'))
                .append(newColumn('暴击伤害', true))
            );
        }

        function initCalculatorDefense(container) {
            container.append(newRow()
                .append(newColumn('穿防系数', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('无视防御', true))
            ).append(newRow()
                .append(newColumn('减防系数', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('防御减免', true))
                .append(symbol('+'))
                .append(newColumn('怪物防御增加', true))
            ).append(newRow()
                .append(newColumn('防御系数'))
                .append(symbol('='))
                .append(newColumn('穿防系数', true))
                .append(symbol('×'))
                .append(newColumn('减防系数', true))
                .append(symbol('×'), '(')
                .append(newColumn('怪物等级'))
                .append(symbol('+', '100', ')'))
            ).append(newRow()
                .append(newColumn('防御对象承伤', true))
                .append(symbol('='), '(')
                .append(newColumn('人物等级'))
                .append(symbol('+', '100', ')', '/', '('))
                .append(newColumn('人物等级'))
                .append(symbol('+', '100', '+'))
                .append(newColumn('防御系数'))
                .append(symbol(')'))
            );
        }

        function initCalculatorResistance(container) {
            container.append(newRow()
                .append(newColumn('元素抗性', true))
                .append(symbol('='))
                .append(newColumn('怪物抗性', true))
                .append(symbol('-'))
                .append(newColumn('元素抗性减免', true))
            ).append(newRow().attr('optional', true)
                .append(newColumn('抗性对象承伤', true))
                .append(symbol('=', '1', '/', '(1', '+', '4', '×'))
                .append(newColumn('元素抗性', true))
                .append(symbol(')'))
            ).append(newRow().attr('optional', true)
                .append(newColumn('抗性对象承伤', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('元素抗性', true))
            ).append(newRow().attr('optional', true)
                .append(newColumn('抗性对象承伤', true))
                .append(symbol('=', '1', '-'))
                .append(newColumn('元素抗性', true))
                .append(symbol('/', '2'))
            );
        }

        function initCalculatorFinalDamage(container) {
            container.append(newRow()
                .append(newColumn('最终伤害'))
                .append(symbol('='))
                .append(newColumn('总攻击力'))
                .append(symbol('×'))
                .append(newColumn('伤害加成系数', true))
                .append(symbol('×'))
                .append(newColumn('暴击收益', true))
                .append(symbol('×'))
                .append(newColumn('防御对象承伤', true))
                .append(symbol('×'))
                .append(newColumn('抗性对象承伤', true))
            )
        }

        $(function () {
            initQuality($('#quality1'), $('#quality2'));
            initCalculator($('#calculator1'), $('#calculator2'));
            $('button[name=setup]').on('click', setupCheckpoint);
            $('button[name=delete]').on('click', deleteCheckpoint);
            $('button[name=reset]').on('click', resetCheckpoint);
            calc();
        });
    </script>
</head>
<body>
<div id='main'>
    <div id='quality1'>
        <fieldset class='Basis'>
            <legend>基础属性</legend>
        </fieldset>
        <fieldset class='Elemental'>
            <legend>元素属性</legend>
        </fieldset>
        <fieldset>
            <legend>比较基准</legend>
            <button name="setup">设置</button>
            <button name="delete">删除</button>
            <button name="reset">重置</button>
        </fieldset>
    </div>
    <div id='quality2'>
        <fieldset class='Advanced'>
            <legend>进阶属性</legend>
        </fieldset>
        <fieldset class='Other'>
            <legend>其他</legend>
        </fieldset>
    </div>
    <div id='calculator1'>
        <fieldset class='Attack'>
            <legend>基础区</legend>
        </fieldset>
        <fieldset class='DamageMultipiler'>
            <legend>倍率区</legend>
        </fieldset>
        <fieldset class='CriticalBracket'>
            <legend>暴击区</legend>
        </fieldset>
        <fieldset class='Resistance'>
            <legend>抗性区</legend>
        </fieldset>
        <fieldset class='ElementalReaction'>
            <legend>反应区</legend>
        </fieldset>
    </div>
    <div id='calculator2'>
        <fieldset class='DamageBonus'>
            <legend>增伤区</legend>
        </fieldset>
        <fieldset class='Defense'>
            <legend>防御区</legend>
        </fieldset>
        <fieldset class='FinalDamage'>
            <legend>最终伤害</legend>
        </fieldset>
    </div>
</div>
</body>
</html>