<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RO计算器</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/static/material-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <script src="/static/common.js"></script>
    <script src="/static/ro.js"></script>
    <style>
        #tabs {
            float: left;
            width: 60%;
        }

        #board {
            float: right;
            width: 39%;
        }

        #tool-bar {
            display: flex;
        }

        h4 {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: antiquewhite;
        }

        h4.top {
            margin-top: 0;
        }

        .buffs {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .buff {
            width: 35%;
            background-color: azure;
        }

        .buff .buff-name {
            float: left;
        }

        .buff .buff-value {
            float: right;
        }

    </style>
    <script>
        let msgDialog;

        function initMessageDialog() {
            return $("#dialog-message").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    "确定": function () {
                        $(this).dialog("close");
                    }
                }
            });
        }

        function initAddEffectDialog() {
            let form;
            const dialog = $("#dialog-add-effect").dialog({
                autoOpen: false,
                width: 380,
                modal: true,
                buttons: {
                    "添加": function () {
                        if (addEffect.call(form)) {
                            dialog.dialog("close");
                        }
                    },
                    "取消": function () {
                        dialog.dialog("close");
                    }
                },
                close: function () {
                    form[0].reset();
                }
            });
            form = dialog.find("form").on("submit", function (event) {
                event.preventDefault();
                if (addEffect.call(form)) {
                    dialog.dialog("close");
                }
            });

            $("#create-effect").on("click", function () {
                dialog.dialog("open");
            });
            const spinner = $("#effect-value").spinner({
                numberFormat: "n",
                min: 0
            });
            $("#effect-name").autocomplete({
                source: Object.keys(manualEffects),
                select: function (event, ui) {
                    const cfg = manualEffects[ui.item.value];
                    spinner.spinner("option", "step", cfg.accuracy);
                }
            });
        }

        function initUploadFile() {
            $('#file').on("change", function () {
                const files = $(this).prop('files');
                if (!files || files.length !== 1) {
                    message("上传配置", "请选择文件");
                    return false;
                }
                const file = files[0];
                if (!file) {
                    message("上传配置", "请选择文件");
                    return false;
                } else if (file.size > 10240) {
                    message("上传配置", "文件太大(限制10K)，请重新选择文件");
                    return false;
                } else {
                    const fd = new FormData();
                    fd.append('player', file);
                    $.post({
                        url: '/player/upload',
                        data: fd,
                        contentType: false,
                        processData: false,
                        dataType: "json"
                    }).done(function (data) {
                        if (data && data.ok && data.data) {
                            refresh(data.data);
                        }
                    }).fail(function (xhr, status, errorThrown) {
                        message("上传配置", "上传失败: [" + status + "]" + errorThrown);
                    })
                }
            });
        }

        function addEffect() {
            const name = $('#effect-name').val();
            const val = $('#effect-value').val();

            const cfg = manualEffects[name];
            if (!cfg) {
                message("添加属性", "未知属性: " + name);
                return false;
            }

            const num = parseFloat(val);
            if (isNaN(num) || num <= 0) {
                message("添加属性", "幅度错误: " + val);
                return false;
            }

            appendToManual(name, '+' + num + cfg.unit)
            return true;
        }

        function appendToManual(name, value) {
            const manual = $('#manual');
            let exist = false;
            $('.buff', manual).each(function (idx, sub) {
                if ($('.buff-name', sub).text() === name) {
                    exist = true;
                    $('.buff-value', sub).text(value);
                }
            });
            if (!exist) {
                manual.append(
                    $.html.div().addClass('buff')
                        .append($.html.div().addClass('buff-name').text(name))
                        .append($.html.div().addClass('buff-value').text(value))
                );
            }
        }

        function refresh(player) {
            $('#manual').children().remove();
            if (player.manual) {
                player.manual.forEach(function (key) {
                    const idx = key.indexOf('+');
                    appendToManual(key.substr(0, idx), key.substring(idx));
                });
            }
            if (player['character-name']) {
                $('#character-name').val(player['character-name']);
            }
        }

        function save() {
            const character = $('#character-name');
            if (!character.val()) {
                message("保存配置", "请输入角色名称!", function () {
                    character.focus();
                });
                return false;
            }

            let manualEffects = [];
            $('.buff', '#manual').each(function (idx, sub) {
                const name = $('.buff-name', sub).text();
                const value = $('.buff-value', sub).text();
                manualEffects.push(name + value);
            });

            let data = {
                'character-name': character.val(),
                manual: manualEffects
            };

            $.post({
                url: '/player/save',
                data: JSON.stringify(data),
                dataType: "json"
            }).done(function () {
                message("保存配置", "保存成功");
            }).fail(function (xhr, status, errorThrown) {
                message("保存配置", "保存失败: [" + status + "]" + errorThrown);
            });
        }

        function load() {
            $.get('/player/load').done(function (data) {
                if (data && data.ok && data.data) {
                    refresh(data.data);
                }
            }).fail(function (xhr, status, errorThrown) {
                message("载入配置", "载入失败: [" + status + "]" + errorThrown);
            });
        }

        function download() {
            window.open('/player/download', '_blank');
        }

        function upload() {
            $('#file').click();
        }

        function message(title, msg, callback) {
            $('#message').text(msg);
            if (callback) {
                msgDialog.on("dialogclose", callback);
            } else {
                msgDialog.off("dialogclose");
            }
            msgDialog.dialog("option", "title", title).dialog("open");
        }

        $(function () {
            $("#tabs").tabs();
            $("#board").accordion({
                heightStyle: "content"
            });
            $('#manual').sortable();

            msgDialog = initMessageDialog();
            initAddEffectDialog();
            initUploadFile();
        });
    </script>
</head>
<body>
<div id="dialog-add-effect" title="添加新的手册属性">
    <form>
        <label for="effect-name">属性: </label>
        <input type="text" id="effect-name">
        <label for="effect-value">幅度: </label>
        <input type="text" id="effect-value" size="4" value="0">
        <!-- Allow form submission with keyboard without duplicating the dialog button -->
        <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </form>
</div>
<div id="dialog-message">
    <p id="message"></p>
</div>
<div id="tool-bar">
    <label for="character-name">角色名称：</label>
    <input type="text" id="character-name">
    <span class="material-icons" onclick="save()">save</span>
    <span class="material-icons" onclick="load()">refresh</span>
    <span class="material-icons" onclick="download()">download</span>
    <span class="material-icons" onclick="upload()">upload</span>
    <input type="file" id="file" accept="application/json" style="display: none"/>
</div>
<div id="tabs">
    <ul>
        <li><a href="#tabs-manual">冒险手册</a></li>
        <li><a href="#tabs-pray">女神祈祷</a></li>
        <li><a href="#tabs-blessing">女神祝福</a></li>
        <li><a href="#tabs-quality">职业素质</a></li>
        <li><a href="#tabs-rune">阿萨神碑</a></li>
        <li><a href="#tabs-gem">符文之匣</a></li>
        <li><a href="#tabs-equip">随身装备</a></li>
    </ul>
    <div id="tabs-manual">
        <h4 class="top">B级冒险家属性</h4>
        <div id="adventurer" class="buffs">
            <div class="buff">
                <div class="buff-name">灵巧</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">力量</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">智力</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">敏捷</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">体质</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">幸运</div>
                <div class="buff-value">+9</div>
            </div>
        </div>
        <h4>手册属性<span id="create-effect" class="material-icons md-18">post_add</span></h4>
        <div id="manual" class="buffs"></div>
    </div>
    <div id="tabs-pray">
    </div>
    <div id="tabs-blessing">
    </div>
    <div id="tabs-quality">
    </div>
    <div id="tabs-rune">
    </div>
    <div id="tabs-gem">
    </div>
    <div id="tabs-equip">
    </div>
</div>
<div id="board">
    <h3>Section 1</h3>
    <div>
        <p>
            Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
            ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
            amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
            odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
        </p>
    </div>
    <h3>Section 2</h3>
    <div>
        <p>
            Sed non urna. Donec et ante. Phasellus eu ligula. Vestibulum sit amet
            purus. Vivamus hendrerit, dolor at aliquet laoreet, mauris turpis porttitor
            velit, faucibus interdum tellus libero ac justo. Vivamus non quam. In
            suscipit faucibus urna.
        </p>
    </div>
    <h3>Section 3</h3>
    <div>
        <p>
            Nam enim risus, molestie et, porta ac, aliquam ac, risus. Quisque lobortis.
            Phasellus pellentesque purus in massa. Aenean in pede. Phasellus ac libero
            ac tellus pellentesque semper. Sed ac felis. Sed commodo, magna quis
            lacinia ornare, quam ante aliquam nisi, eu iaculis leo purus venenatis dui.
        </p>
        <ul>
            <li>List item one</li>
            <li>List item two</li>
            <li>List item three</li>
        </ul>
    </div>
    <h3>Section 4</h3>
    <div>
        <p>
            Cras dictum. Pellentesque habitant morbi tristique senectus et netus
            et malesuada fames ac turpis egestas. Vestibulum ante ipsum primis in
            faucibus orci luctus et ultrices posuere cubilia Curae; Aenean lacinia
            mauris vel est.
        </p>
        <p>
            Suspendisse eu nisl. Nullam ut libero. Integer dignissim consequat lectus.
            Class aptent taciti sociosqu ad litora torquent per conubia nostra, per
            inceptos himenaeos.
        </p>
    </div>
</div>
</body>
</html>