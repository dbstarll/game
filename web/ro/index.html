<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RO计算器</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/ro/css/normalize.css">
    <link rel="stylesheet" href="/ro/css/material-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <script src="/ro/js/jsonpath-0.8.0.js"></script>
    <script src="/ro/js/common.js"></script>
    <script src="/ro/js/ro.js"></script>
    <script src="/ro/js/buff.js"></script>
    <script src="/ro/js/buffs.js"></script>
    <script src="/ro/js/moniqi/moniqi_data_file_1637826700.js"></script>
    <style>
        html {
            font-size: 14px;
        }

        #main {
            display: flex;
            margin: 5px;
            column-gap: 5px;
        }

        #main > div:first-child {
            flex: 2;
        }

        #main > div:last-child {
            flex: 1;
        }

        #tool-bar {
            display: flex;
            float: right;
            align-items: center;
            margin: 9px 0 0 0;
        }

        h4 {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: antiquewhite;
            border-radius: 10px;
        }

        h4.top {
            margin-top: 0;
        }

        form {
            display: flex;
            align-items: center;
        }

        .buffs {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .buff {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: small;
        }

        #tabs-manual .buff {
            width: 40%;
            border-bottom: 1px dotted black;
        }

        #tabs-union .buff {
            padding: 5px;
            border: 1px dotted gray;
            border-radius: 5px;
            margin: 2px;
        }

        #tabs-rune .buff {
            padding: 5px;
            border: 1px dotted gray;
            border-radius: 5px;
            margin: 2px;
            width: 30%;
        }

        .buff .buff-title {
            background-color: orange;
            border-radius: 10px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .buff .buff-name {
            float: left;
        }

        .buff .buff-value {
            float: right;
        }

        #tabs-union .pray {
            float: left;
            width: 30%;
        }

        #tabs-union .blessing {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            float: right;
            width: 69%;
        }

        #tabs-union .blessing h4 {
            width: 100%;
        }

        #tabs-union .blessing .attack {
            width: 33%;
        }

        #tabs-union .blessing .defence {
            width: 33%;
        }

        #tabs-union .blessing .element {
            width: 33%;
        }

        #tabs-union .blessing .attack .buff {
            background-color: pink;
        }

        #tabs-union .blessing .defence .buff {
            background-color: lightcyan;
        }

        #tabs-union .blessing .element .buff {
            background-color: lightyellow;
        }

        #tabs-quality .job {
            float: left;
            width: 30%;
        }

        #job-level-handle, #base-level-handle {
            width: 3em;
            height: 1.6em;
            top: 50%;
            margin-top: -.8em;
            text-align: center;
            line-height: 1.6em;
        }
    </style>
    <script>
        function initMessageDialog() {
            return $("#dialog-message").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    "确定": function () {
                        $(this).dialog("close");
                    }
                },
                close: function () {
                    $(this).off("dialogclose");
                }
            });
        }

        function initConfirmDialog() {
            return $("#dialog-confirm").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    "确定": function () {
                        $(this).attr('confirm', 'true').dialog("close");
                    },
                    "取消": function () {
                        $(this).dialog("close");
                    }
                },
                close: function () {
                    $(this).off("dialogclose");
                }
            });
        }

        function initAddEffectDialog() {
            let form;
            const dialog = $("#dialog-add-effect").dialog({
                autoOpen: false,
                width: 380,
                modal: true,
                buttons: {
                    "添加": function () {
                        if (addEffect.call(form)) {
                            dialog.dialog("close");
                        }
                    },
                    "取消": function () {
                        dialog.dialog("close");
                    }
                },
                close: function () {
                    form[0].reset();
                }
            });
            form = dialog.find("form").on("submit", function (event) {
                event.preventDefault();
                if (addEffect.call(form)) {
                    dialog.dialog("close");
                }
            });

            $("#create-effect-manual").on("click", function () {
                $.data(form, 'add-target', '#manual');
                dialog.dialog("option", "title", '添加新的手册属性').dialog("open");
            });
            $("#create-effect-rune").on("click", function () {
                $.data(form, 'add-target', '#rune');
                dialog.dialog("option", "title", '添加新的神碑属性').dialog("open");
            });
            const spinner = $("#effect-value").spinner({
                numberFormat: "n",
                min: 0
            }).on('focus', function () {
                $(this).select();
            });
            $("#effect-name").autocomplete({
                source: Object.keys(manualEffects),
                select: function (event, ui) {
                    const cfg = manualEffects[ui.item.value];
                    spinner.spinner("option", "step", cfg.accuracy);
                }
            });
        }

        function initEditEffectDialog() {
            let form;
            const dialog = $("#dialog-edit-effect").dialog({
                autoOpen: false,
                width: 380,
                modal: true,
                buttons: {
                    "修改": function () {
                        dialog.attr('confirm', 'true').dialog("close");
                    },
                    "取消": function () {
                        dialog.dialog("close");
                    }
                },
                close: function () {
                    form[0].reset();
                    dialog.off('dialogbeforeclose');
                }
            });
            form = dialog.find("form").on("submit", function (event) {
                event.preventDefault();
                dialog.attr('confirm', 'true').dialog("close");
            });

            const spinner = $("#edit-effect-value").spinner({
                numberFormat: "n",
                min: 0
            }).on('focus', function () {
                $(this).select();
            });

            form.children('.min').on('click', function () {
                spinner.spinner("value", 0);
            });
            form.children('.max').on('click', function () {
                const max = spinner.spinner("option", "max");
                if ('number' === typeof max) {
                    spinner.spinner("value", max);
                }
            });

            return dialog;
        }

        function initToolBar() {
            const bar = $('#tool-bar');
            $('span[role=download]', bar).on('click', download).hide();
            $('span[role=save]', bar).on('click', save).hide();
            $('span[role=load]', bar).on('click', load);
            $('span[role=upload]', bar).on('click', upload);
            initUploadFile($('input[type=file]', bar).hide());
        }

        function initUploadFile(file) {
            file.on("change", function () {
                const files = $(this).prop('files');
                if (!files || files.length !== 1) {
                    message("上传配置", "请选择文件");
                    return false;
                }
                const file = files[0];
                if (!file) {
                    message("上传配置", "请选择文件");
                    return false;
                } else if (file.size > 10240) {
                    message("上传配置", "文件太大(限制10K)，请重新选择文件");
                    return false;
                } else {
                    const fd = new FormData();
                    fd.append('player', file);
                    $.post({
                        url: '/player/upload',
                        data: fd,
                        cache: false,
                        contentType: false,
                        processData: false,
                        dataType: "json"
                    }).done(function (data) {
                        if (data && data.ok && data.data) {
                            refresh(data.data);
                            saved();
                            downloaded();
                        }
                    }).fail(function (xhr, status, errorThrown) {
                        message("上传配置", "上传失败: [" + status + "]" + errorThrown);
                    })
                }
            });
        }

        function initJobSelect() {
            const baseSlider = $("#base-level").slider({
                range: "min",
                create: function () {
                    $("#base-level-handle").text($(this).slider("value"));
                },
                slide: function (event, ui) {
                    $("#base-level-handle").text(ui.value);
                },
                change: function (event, ui) {
                    $("#base-level-handle").text(ui.value);
                }
            });

            const jobSlider = $("#job-level").slider({
                range: "min",
                create: function () {
                    $("#job-level-handle").text($(this).slider("value"));
                },
                slide: function (event, ui) {
                    $("#job-level-handle").text(ui.value);
                },
                change: function (event, ui) {
                    $("#job-level-handle").text(ui.value);
                }
            });

            const jobs = $('#job').selectmenu({
                change: function (event, ui) {
                    const jobId = ui.item.value;
                    const job = MONIQI_DATA.job_data[jobId];
                    console.log(job);
                    baseSlider.slider("option", "min", job.MinBaseLevel);
                    baseSlider.slider("option", "max", job.MaxBaseLevel);
                    baseSlider.slider("option", "value", job.MaxBaseLevel);
                    jobSlider.slider("option", "min", job.MinJobLevel);
                    jobSlider.slider("option", "max", job.MaxJobLevel);
                    jobSlider.slider("option", "value", job.MaxJobLevel);
                }
            });
            Object.keys(MONIQI_DATA.type_data).forEach(function (key) {
                const type = MONIQI_DATA.type_data[key];
                const group = $('<optgroup>').attr('label', type.Name + '系');
                type.Jobs.forEach(function (jobId) {
                    group.append($('<option>').val(jobId).text(MONIQI_DATA.job_data[jobId].NameZh));
                });
                jobs.append(group);
            });
        }

        function saving() {
            $('#tool-bar > span[role=save]').show();
        }

        function saved() {
            $('#tool-bar > span[role=save]').hide();
        }

        function needSave() {
            return $('#tool-bar > span[role=save]').css('display') !== 'none';
        }

        function downloading() {
            $('#tool-bar > span[role=download]').show();
        }

        function downloaded() {
            $('#tool-bar > span[role=download]').hide();
        }

        function needDownload() {
            return $('#tool-bar > span[role=download]').css('display') !== 'none';
        }


        function addEffect() {
            const addTarget = $.data(this, 'add-target');
            const name = $('#effect-name').val();
            const val = $('#effect-value').val();
            let result = true;
            $(addTarget).buffs().addBuff({effect: name}, val, function (error) {
                message("添加属性: " + name, error);
                result = false;
            });
            return result;
        }

        function refresh(data) {
            $('#manual').buffs().decode(jsonPath(data, '$.player.manual.*'));
            const union = $('#tabs-union');
            $('.pray', union).buffs().decode(jsonPath(data, '$.player.union.pray.*'));
            $('.attack', union).buffs().decode(jsonPath(data, '$.player.union.attack.*'));
            $('.defence', union).buffs().decode(jsonPath(data, '$.player.union.defence.*'));
            $('.element', union).buffs().decode(jsonPath(data, '$.player.union.element.*'));
            $('#rune').buffs().decode(jsonPath(data, '$.player.rune.*'));

            const player = data.player;
            if (player) {
                if (player['character-name']) {
                    $('#character-name').text(player['character-name']);
                }
            }

            const character = data.character;
            if (character) {
                console.log(character);
            }
        }

        function save() {
            const character = $('#character-name');
            if (!character.text()) {
                message("保存配置", "请输入角色名称!");
                return false;
            }

            const union = $('#tabs-union');
            let data = {
                'character-name': character.text(),
                manual: $('#manual').buffs().encode(),
                union: {
                    pray: $('.pray', union).buffs().encode(),
                    attack: $('.attack', union).buffs().encode(),
                    defence: $('.defence', union).buffs().encode(),
                    element: $('.element', union).buffs().encode()
                },
                rune: $('#rune').buffs().encode()
            };

            $.post({
                url: '/player/save',
                data: JSON.stringify(data),
                cache: false,
                dataType: "json"
            }).done(function () {
                message("保存配置", "保存成功", function () {
                    saved();
                    downloading();
                });
            }).fail(function (xhr, status, errorThrown) {
                message("保存配置", "保存失败: [" + status + "]" + errorThrown);
            });
        }

        function load() {
            const fn = function () {
                $.get({
                    url: '/player/load',
                    cache: false,
                    dataType: "json"
                }).done(function (data) {
                    if (data && data.ok && data.data) {
                        refresh(data.data);
                        saved();
                        message("载入配置", "载入完成");
                    }
                }).fail(function (xhr, status, errorThrown) {
                    message("载入配置", "载入失败: [" + status + "]" + errorThrown);
                });
            };
            if (needSave()) {
                confirm("载入配置", "有修改的内容未保存，继续载入会使新修改的内容丢失，请确认是否需要继续载入？", fn);
            } else {
                return fn();
            }
        }

        function download() {
            const fn = function () {
                window.open('/player/download', '_blank');
                downloaded();
            }
            if (needSave()) {
                confirm("下载配置", "有修改的内容未保存，继续下载会忽略新修改的内容，请确认是否需要继续下载？", fn);
            } else {
                return fn();
            }
        }

        function upload() {
            const fn = function () {
                $('#tool-bar > input[type=file]').click();
            }
            const fn2 = function () {
                if (needDownload()) {
                    confirm("上传配置", "有修改的内容未下载，继续上传会忽略新修改的内容，请确认是否需要继续上传？", fn);
                } else {
                    return fn();
                }
            }
            if (needSave()) {
                confirm("上传配置", "有修改的内容未保存，继续上传会忽略新修改的内容，请确认是否需要继续上传？", fn2);
            } else {
                return fn2();
            }
        }

        function message(title, msg, callback) {
            $('#message').text(msg);
            if (callback) {
                $("#dialog-message").on("dialogclose", callback);
            }
            $("#dialog-message").dialog("option", "title", title).dialog("open");
        }

        function confirm(title, msg, callback) {
            $('#confirm').text(msg);
            const dialog = $("#dialog-confirm").attr("confirm", "false");
            if (callback) {
                dialog.on("dialogclose", function () {
                    if (dialog.attr('confirm') === 'true') {
                        setTimeout(callback, 200);
                    }
                });
            }
            dialog.dialog("option", "title", title).dialog("open");
        }

        function editEffect(dialog) {
            const item = $.ro.buff.getConfig(this);
            const buff = $(this).buff();
            $('#edit-effect-name', dialog).text(buff.name());
            const spinner = $('#edit-effect-value', dialog).val(buff.value() || 0);
            if (item) {
                if (item.max) {
                    spinner.spinner("option", "max", item.max);
                    $('.max', dialog).show();
                } else {
                    spinner.spinner("option", "max", null);
                    $('.max', dialog).hide();
                }
                spinner.spinner("option", "step", item.accuracy || 1);
            }

            dialog.on("dialogbeforeclose", function () {
                if (dialog.attr('confirm') === 'true') {
                    dialog.removeAttr('confirm');
                    const val = $('#edit-effect-value', dialog).val();
                    let close = true;
                    buff.value(val, function (error) {
                        message("修改属性: " + buff.name(), error);
                        close = false;
                    });
                    return close;
                }
            }).attr("confirm", "false").dialog("open");
        }

        $(function () {
            $("#tabs").tabs({
                active: 2
            });
            $("#board").accordion({
                heightStyle: "content"
            });
            $('.saved').on("change", saving);

            initMessageDialog();
            initConfirmDialog();
            initAddEffectDialog();
            const editDialog = initEditEffectDialog();
            initToolBar();
            initJobSelect();


            initAllBuffs(editDialog);

            load();
        });

        function initAllBuffs(dialog) {
            $('#adventurer').buffs().decode(["灵巧+9", "力量+9", "智力+9", "敏捷+9", "体质+9", "幸运+9"]);

            initBuffs($('#manual').sortable().on("sortupdate", saving), dialog, true);

            const union = $('#tabs-union');
            initBuffs($('.pray', union), dialog, false, {zero: true}, STORE.union.pray);
            initBuffs($('.attack', union), dialog, false, {zero: true}, STORE.union.blessing.attack);
            initBuffs($('.defence', union), dialog, false, {zero: true}, STORE.union.blessing.defence);
            initBuffs($('.element', union), dialog, false, {zero: true}, STORE.union.blessing.element);

            initBuffs($('#rune').sortable().on("sortupdate", saving), dialog, true);

            saved();
        }

        function initBuffs(container, dialog, dynamic, buff, items) {
            container.buffs({
                dynamic: dynamic,
                buff: buff,
                click: function () {
                    editEffect.call(this, dialog);
                },
                change: saving
            }, items).reset();
        }
    </script>
</head>
<body>
<div id="dialog-add-effect">
    <form>
        <label for="effect-name">属性: </label>
        <input type="text" id="effect-name">
        <label for="effect-value">幅度: </label>
        <input type="text" id="effect-value" size="5" value="0">
        <!-- Allow form submission with keyboard without duplicating the dialog button -->
        <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </form>
</div>
<div id="dialog-edit-effect" title="修改属性">
    <form>
        <label id="edit-effect-name" for="edit-effect-value"></label>
        <span class="material-icons">add</span>
        <input id="edit-effect-value" type="text" size="8">
        <span class="material-icons min">delete_forever</span>
        <span class="material-icons max">trending_up</span>
        <!-- Allow form submission with keyboard without duplicating the dialog button -->
        <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </form>
</div>
<div id="dialog-message">
    <p id="message"></p>
</div>
<div id="dialog-confirm">
    <p id="confirm"></p>
</div>

<div id="main">
    <div id="tabs">
        <ul>
            <li><a href="#tabs-manual">冒险手册</a></li>
            <li><a href="#tabs-union">工会女神</a></li>
            <li><a href="#tabs-quality">职业素质</a></li>
            <li><a href="#tabs-rune">阿萨神碑</a></li>
            <li><a href="#tabs-gem">符文之匣</a></li>
            <li><a href="#tabs-equip">随身装备</a></li>
            <li id="tool-bar">
                <input type="file" accept="application/json"/>
                <span role="upload" class="material-icons">upload</span>
                <span role="load" class="material-icons">refresh</span>
                <span role="save" class="material-icons">save</span>
                <span role="download" class="material-icons">download</span>
                <label id="character-name">匿名用户</label>
            </li>
        </ul>
        <div id="tabs-manual">
            <h4 class="top">B级冒险家属性</h4>
            <div id="adventurer" class="buffs"></div>
            <h4 id="create-effect-manual">手册属性<span class="material-icons md-18">post_add</span></h4>
            <div id="manual" class="buffs"></div>
        </div>
        <div id="tabs-union">
            <div class="pray">
                <h4 class="top">女神祈祷</h4>
            </div>
            <div class="blessing">
                <h4 class="top">女神祝福</h4>
                <div class="attack"></div>
                <div class="defence"></div>
                <div class="element"></div>
            </div>
        </div>
        <div id="tabs-quality">
            <div class="job">
                <label for="job">职业</label>
                <select id="job">
                    <option disabled selected>请选择职业</option>
                </select>
                <label for="base-level">Base</label>
                <div id="base-level">
                    <div id="base-level-handle" class="ui-slider-handle"></div>
                </div>
                <label for="job-level">Job</label>
                <div id="job-level">
                    <div id="job-level-handle" class="ui-slider-handle"></div>
                </div>
            </div>
        </div>
        <div id="tabs-rune">
            <h4 id="create-effect-rune" class="top">神碑属性<span class="material-icons md-18">post_add</span></h4>
            <div id="rune" class="buffs"></div>
        </div>
        <div id="tabs-gem">
        </div>
        <div id="tabs-equip">
        </div>
    </div>
    <div id="board">
        <h3>Section 1</h3>
        <div>
            <p>
                Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
                ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
                amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
                odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
            </p>
        </div>
        <h3>Section 2</h3>
        <div>
            <p>
                Sed non urna. Donec et ante. Phasellus eu ligula. Vestibulum sit amet
                purus. Vivamus hendrerit, dolor at aliquet laoreet, mauris turpis porttitor
                velit, faucibus interdum tellus libero ac justo. Vivamus non quam. In
                suscipit faucibus urna.
            </p>
        </div>
        <h3>Section 3</h3>
        <div>
            <p>
                Nam enim risus, molestie et, porta ac, aliquam ac, risus. Quisque lobortis.
                Phasellus pellentesque purus in massa. Aenean in pede. Phasellus ac libero
                ac tellus pellentesque semper. Sed ac felis. Sed commodo, magna quis
                lacinia ornare, quam ante aliquam nisi, eu iaculis leo purus venenatis dui.
            </p>
            <ul>
                <li>List item one</li>
                <li>List item two</li>
                <li>List item three</li>
            </ul>
        </div>
        <h3>Section 4</h3>
        <div>
            <p>
                Cras dictum. Pellentesque habitant morbi tristique senectus et netus
                et malesuada fames ac turpis egestas. Vestibulum ante ipsum primis in
                faucibus orci luctus et ultrices posuere cubilia Curae; Aenean lacinia
                mauris vel est.
            </p>
            <p>
                Suspendisse eu nisl. Nullam ut libero. Integer dignissim consequat lectus.
                Class aptent taciti sociosqu ad litora torquent per conubia nostra, per
                inceptos himenaeos.
            </p>
        </div>
    </div>
</div>
</body>
</html>