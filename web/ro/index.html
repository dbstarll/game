<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RO计算器</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/static/material-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <script src="/static/common.js"></script>
    <script src="/static/ro.js"></script>
    <style>
        #tabs {
            float: left;
            width: 60%;
        }

        #board {
            float: right;
            width: 39%;
        }

        #tool-bar {
            display: flex;
        }

        h4 {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: antiquewhite;
            border-radius: 10px;
        }

        h4.top {
            margin-top: 0;
        }

        .buffs {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .buff {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #tabs-manual .buff {
            width: 40%;
            border-bottom: 1px dotted black;
        }

        #tabs-union .buff {
            padding: 5px;
            border: 1px dotted gray;
            border-radius: 5px;
            margin: 5px;
        }

        .buff .buff-title {
            background-color: orange;
            border-radius: 10px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .buff .buff-name {
            float: left;
        }

        .buff .buff-value {
            float: right;
        }

        #tabs-union .pray {
            float: left;
            width: 30%;
        }

        #tabs-union .blessing {
            float: right;
            width: 69%;
        }

    </style>
    <script>
        function initMessageDialog() {
            return $("#dialog-message").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    "确定": function () {
                        $(this).dialog("close");
                    }
                },
                close: function () {
                    $(this).off("dialogclose");
                }
            });
        }

        function initConfirmDialog() {
            return $("#dialog-confirm").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    "确定": function () {
                        $(this).attr('confirm', 'true').dialog("close");
                    },
                    "取消": function () {
                        $(this).dialog("close");
                    }
                },
                close: function () {
                    $(this).off("dialogclose");
                }
            });
        }

        function initAddEffectDialog() {
            let form;
            const dialog = $("#dialog-add-effect").dialog({
                autoOpen: false,
                width: 380,
                modal: true,
                buttons: {
                    "添加": function () {
                        if (addEffect.call(form)) {
                            dialog.dialog("close");
                        }
                    },
                    "取消": function () {
                        dialog.dialog("close");
                    }
                },
                close: function () {
                    form[0].reset();
                }
            });
            form = dialog.find("form").on("submit", function (event) {
                event.preventDefault();
                if (addEffect.call(form)) {
                    dialog.dialog("close");
                }
            });

            $("#create-effect").on("click", function () {
                dialog.dialog("open");
            });
            const spinner = $("#effect-value").spinner({
                numberFormat: "n",
                min: 0
            });
            $("#effect-name").autocomplete({
                source: Object.keys(manualEffects),
                select: function (event, ui) {
                    const cfg = manualEffects[ui.item.value];
                    spinner.spinner("option", "step", cfg.accuracy);
                }
            });
        }

        function initUploadFile() {
            $('#file').on("change", function () {
                const files = $(this).prop('files');
                if (!files || files.length !== 1) {
                    message("上传配置", "请选择文件");
                    return false;
                }
                const file = files[0];
                if (!file) {
                    message("上传配置", "请选择文件");
                    return false;
                } else if (file.size > 10240) {
                    message("上传配置", "文件太大(限制10K)，请重新选择文件");
                    return false;
                } else {
                    const fd = new FormData();
                    fd.append('player', file);
                    $.post({
                        url: '/player/upload',
                        data: fd,
                        cache: false,
                        contentType: false,
                        processData: false,
                        dataType: "json"
                    }).done(function (data) {
                        if (data && data.ok && data.data) {
                            refresh(data.data);
                            saved();
                            $('#download').hide();
                        }
                    }).fail(function (xhr, status, errorThrown) {
                        message("上传配置", "上传失败: [" + status + "]" + errorThrown);
                    })
                }
            });
        }

        function saving() {
            $('#save').show();
        }

        function saved() {
            $('#save').hide();
        }

        function addEffect() {
            const name = $('#effect-name').val();
            const val = $('#effect-value').val();

            const cfg = manualEffects[name];
            if (!cfg) {
                message("添加属性", "未知属性: " + name);
                return false;
            }

            const num = parseFloat(val);
            if (isNaN(num) || num <= 0) {
                message("添加属性", "幅度错误: " + val);
                return false;
            }

            appendToManual(name, num, cfg);
            saving();
            return true;
        }

        function appendToManual(name, num, cfg) {
            const value = '+' + num.toFixed(cfg.accuracy == 0.1 ? 1 : 0) + cfg.unit;
            const manual = $('#manual');
            let exist = false;
            $('.buff', manual).each(function (idx, sub) {
                if ($('.buff-name', sub).text() === name) {
                    exist = true;
                    $('.buff-value', sub).text(value);
                }
            });
            if (!exist) {
                manual.append(
                    $.html.div().addClass('buff')
                        .append($.html.div().addClass('buff-name').text(name))
                        .append($.html.div().addClass('buff-value').text(value))
                );
            }
        }

        function refresh(data) {
            $('#manual').children().remove();

            if (data) {
                const player = data.player;
                if (player) {
                    const manual = player.manual;
                    if (manual) {
                        manual.forEach(function (key) {
                            const idx = key.indexOf('+');
                            const name = key.substr(0, idx);
                            const val = key.substring(idx);

                            const cfg = manualEffects[name];
                            if (cfg) {
                                const num = parseFloat(val);
                                if (!isNaN(num) && num > 0) {
                                    appendToManual(name, num, cfg);
                                }
                            }
                        });
                    }
                    if (player['character-name']) {
                        $('#character-name').val(player['character-name']);
                    }
                }

                const character = data.character;
                if (character) {
                    console.log(character);
                }
            }
        }

        function save() {
            const character = $('#character-name');
            if (!character.val()) {
                message("保存配置", "请输入角色名称!", function () {
                    character.focus();
                });
                return false;
            }

            let manualEffects = [];
            $('.buff', '#manual').each(function (idx, sub) {
                const name = $('.buff-name', sub).text();
                const value = $('.buff-value', sub).text();
                manualEffects.push(name + value);
            });

            let data = {
                'character-name': character.val(),
                manual: manualEffects
            };

            $.post({
                url: '/player/save',
                data: JSON.stringify(data),
                cache: false,
                dataType: "json"
            }).done(function () {
                message("保存配置", "保存成功", function () {
                    saved();
                    $('#download').show();
                });
            }).fail(function (xhr, status, errorThrown) {
                message("保存配置", "保存失败: [" + status + "]" + errorThrown);
            });
        }

        function load() {
            const fn = function () {
                $.get({
                    url: '/player/load',
                    cache: false,
                    dataType: "json"
                }).done(function (data) {
                    if (data && data.ok && data.data) {
                        refresh(data.data);
                        message("载入配置", "载入完成", saved);
                    }
                }).fail(function (xhr, status, errorThrown) {
                    message("载入配置", "载入失败: [" + status + "]" + errorThrown);
                });
            };
            if ($('#save').css('display') === 'block') {
                confirm("载入配置", "有修改的内容未保存，继续载入会使新修改的内容丢失，请确认是否需要继续载入？", fn);
            } else {
                return fn();
            }
        }

        function download() {
            const fn = function () {
                window.open('/player/download', '_blank');
                $('#download').hide();
            }
            if ($('#save').css('display') === 'block') {
                confirm("下载配置", "有修改的内容未保存，继续下载会忽略新修改的内容，请确认是否需要继续下载？", fn);
            } else {
                return fn();
            }
        }

        function upload() {
            const fn = function () {
                $('#file').click();
            }
            const fn2 = function () {
                if ($('#download').css('display') === 'block') {
                    confirm("上传配置", "有修改的内容未下载，继续上传会忽略新修改的内容，请确认是否需要继续上传？", fn);
                } else {
                    return fn();
                }
            }
            if ($('#save').css('display') === 'block') {
                confirm("上传配置", "有修改的内容未保存，继续上传会忽略新修改的内容，请确认是否需要继续上传？", fn2);
            } else {
                return fn2();
            }
        }

        function message(title, msg, callback) {
            $('#message').text(msg);
            if (callback) {
                $("#dialog-message").on("dialogclose", callback);
            }
            $("#dialog-message").dialog("option", "title", title).dialog("open");
        }

        function confirm(title, msg, callback) {
            $('#confirm').text(msg);
            const dialog = $("#dialog-confirm").attr("confirm", "false");
            if (callback) {
                dialog.on("dialogclose", function () {
                    if (dialog.attr('confirm') === 'true') {
                        setTimeout(callback, 200);
                    }
                });
            }
            dialog.dialog("option", "title", title).dialog("open");
        }

        $(function () {
            $("#tabs").tabs();
            $("#board").accordion({
                heightStyle: "content"
            });
            $('#manual').sortable().on("sortupdate", saving);
            $('.saved').on("change", saving);

            initMessageDialog();
            initConfirmDialog();
            initAddEffectDialog();
            initUploadFile();

            load();
        });
    </script>
</head>
<body>
<div id="dialog-add-effect" title="添加新的手册属性">
    <form>
        <label for="effect-name">属性: </label>
        <input type="text" id="effect-name">
        <label for="effect-value">幅度: </label>
        <input type="text" id="effect-value" size="5" value="0">
        <!-- Allow form submission with keyboard without duplicating the dialog button -->
        <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </form>
</div>
<div id="dialog-message">
    <p id="message"></p>
</div>
<div id="dialog-confirm">
    <p id="confirm"></p>
</div>
<div id="tool-bar">
    <label for="character-name">角色名称：</label>
    <input type="text" id="character-name" class="saved">
    <span class="material-icons" onclick="upload()">upload</span>
    <span class="material-icons" onclick="load()">refresh</span>
    <span id="save" class="material-icons" onclick="save()" style="display: none">save</span>
    <span id="download" class="material-icons" onclick="download()" style="display: none">download</span>
    <input type="file" id="file" accept="application/json" style="display: none"/>
</div>
<div id="tabs">
    <ul>
        <li><a href="#tabs-manual">冒险手册</a></li>
        <li><a href="#tabs-union">工会女神</a></li>
        <li><a href="#tabs-quality">职业素质</a></li>
        <li><a href="#tabs-rune">阿萨神碑</a></li>
        <li><a href="#tabs-gem">符文之匣</a></li>
        <li><a href="#tabs-equip">随身装备</a></li>
    </ul>
    <div id="tabs-manual">
        <h4 class="top">B级冒险家属性</h4>
        <div id="adventurer" class="buffs">
            <div class="buff">
                <div class="buff-name">灵巧</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">力量</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">智力</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">敏捷</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">体质</div>
                <div class="buff-value">+9</div>
            </div>
            <div class="buff">
                <div class="buff-name">幸运</div>
                <div class="buff-value">+9</div>
            </div>
        </div>
        <h4>手册属性<span id="create-effect" class="material-icons md-18">post_add</span></h4>
        <div id="manual" class="buffs"></div>
    </div>
    <div id="tabs-union">
        <div class="pray">
            <h4 class="top">女神祈祷</h4>
            <div class="buff">
                <div class="buff-title">生命祝福</div>
                <div class="buff-name">生命上限</div>
                <div class="buff-value">+0</div>
            </div>
            <div class="buff">
                <div class="buff-title">战斗祝福</div>
                <div class="buff-name">物理攻击</div>
                <div class="buff-value">+0</div>
            </div>
            <div class="buff">
                <div class="buff-title">智慧祝福</div>
                <div class="buff-name">魔法攻击</div>
                <div class="buff-value">+0</div>
            </div>
            <div class="buff">
                <div class="buff-title">生存祝福</div>
                <div class="buff-name">物理防御</div>
                <div class="buff-value">+0</div>
            </div>
            <div class="buff">
                <div class="buff-title">抗魔祝福</div>
                <div class="buff-name">魔法防御</div>
                <div class="buff-value">+0</div>
            </div>
        </div>
        <div class="blessing">
            <h4 class="top">女神祝福</h4>
        </div>
    </div>
    <div id="tabs-quality">
    </div>
    <div id="tabs-rune">
    </div>
    <div id="tabs-gem">
    </div>
    <div id="tabs-equip">
    </div>
</div>
<div id="board">
    <h3>Section 1</h3>
    <div>
        <p>
            Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
            ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
            amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
            odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
        </p>
    </div>
    <h3>Section 2</h3>
    <div>
        <p>
            Sed non urna. Donec et ante. Phasellus eu ligula. Vestibulum sit amet
            purus. Vivamus hendrerit, dolor at aliquet laoreet, mauris turpis porttitor
            velit, faucibus interdum tellus libero ac justo. Vivamus non quam. In
            suscipit faucibus urna.
        </p>
    </div>
    <h3>Section 3</h3>
    <div>
        <p>
            Nam enim risus, molestie et, porta ac, aliquam ac, risus. Quisque lobortis.
            Phasellus pellentesque purus in massa. Aenean in pede. Phasellus ac libero
            ac tellus pellentesque semper. Sed ac felis. Sed commodo, magna quis
            lacinia ornare, quam ante aliquam nisi, eu iaculis leo purus venenatis dui.
        </p>
        <ul>
            <li>List item one</li>
            <li>List item two</li>
            <li>List item three</li>
        </ul>
    </div>
    <h3>Section 4</h3>
    <div>
        <p>
            Cras dictum. Pellentesque habitant morbi tristique senectus et netus
            et malesuada fames ac turpis egestas. Vestibulum ante ipsum primis in
            faucibus orci luctus et ultrices posuere cubilia Curae; Aenean lacinia
            mauris vel est.
        </p>
        <p>
            Suspendisse eu nisl. Nullam ut libero. Integer dignissim consequat lectus.
            Class aptent taciti sociosqu ad litora torquent per conubia nostra, per
            inceptos himenaeos.
        </p>
    </div>
</div>
</body>
</html>